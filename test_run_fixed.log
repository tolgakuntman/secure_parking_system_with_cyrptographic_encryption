
==== Sanity checks ====
[INFO] Sanity checks passed
[INFO] Fresh start: docker compose down -v --remove-orphans
 Container ho-container  Stopping
 Container ho-container  Stopped
 Container ho-container  Removing
 Container ho-container  Removed
 Container sp-container  Stopping
 Container sp-container  Stopped
 Container sp-container  Removing
 Container sp-container  Removed
 Container cauth-container  Stopping
 Container cauth-container  Stopped
 Container cauth-container  Removing
 Container cauth-container  Removed
 Volume secure_software_assignment_co_keystore  Removing
 Network secure_software_assignment_java-network  Removing
 Volume secure_software_assignment_ho_keystore  Removing
 Volume secure_software_assignment_sp_keystore  Removing
 Volume secure_software_assignment_co_keystore  Removed
 Volume secure_software_assignment_ho_keystore  Removed
 Volume secure_software_assignment_sp_keystore  Removed
 Network secure_software_assignment_java-network  Removed
[INFO] Starting core services: cauth, sp, ho
#1 [internal] load local bake definitions
#1 reading from stdin 1.59kB done
#1 DONE 0.0s

#2 [ho internal] load build definition from Dockerfile
#2 transferring dockerfile: 346B done
#2 DONE 0.0s

#3 [cauth internal] load build definition from Dockerfile
#3 transferring dockerfile: 756B done
#3 DONE 0.0s

#4 [sp internal] load build definition from Dockerfile
#4 transferring dockerfile: 652B done
#4 DONE 0.0s

#5 [cauth internal] load metadata for docker.io/library/eclipse-temurin:17-jdk
#5 DONE 0.8s

#6 [ho internal] load metadata for docker.io/library/eclipse-temurin:17-jre
#6 DONE 0.8s

#7 [ho internal] load metadata for docker.io/library/maven:3.9-eclipse-temurin-17
#7 DONE 0.8s

#8 [cauth internal] load .dockerignore
#8 transferring context: 91B done
#8 DONE 0.0s

#9 [ho internal] load .dockerignore
#9 transferring context: 2B done
#9 DONE 0.0s

#10 [sp internal] load .dockerignore
#10 transferring context: 91B done
#10 DONE 0.0s

#11 [ho build 1/5] FROM docker.io/library/maven:3.9-eclipse-temurin-17@sha256:f7ae6cafd12a38da76a1a105744522387b32caacba5e23674a652133607d007c
#11 DONE 0.0s

#12 [ho stage-1 1/3] FROM docker.io/library/eclipse-temurin:17-jre@sha256:fc0c46c43f873754d8651948b94da946449aee0c0262420a86c4d18e84bc3c49
#12 DONE 0.0s

#13 [cauth 1/5] FROM docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778
#13 resolve docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778 0.0s done
#13 DONE 0.0s

#14 [ho internal] load build context
#14 transferring context: 305B done
#14 DONE 0.0s

#15 [cauth internal] load build context
#15 transferring context: 527B done
#15 DONE 0.0s

#16 [sp internal] load build context
#16 transferring context: 528B done
#16 DONE 0.0s

#17 [ho build 4/5] COPY src ./src
#17 CACHED

#18 [ho stage-1 2/3] WORKDIR /app
#18 CACHED

#19 [ho build 5/5] RUN mvn clean package -DskipTests
#19 CACHED

#20 [ho build 2/5] WORKDIR /app
#20 CACHED

#21 [ho build 3/5] COPY pom.xml .
#21 CACHED

#22 [ho stage-1 3/3] COPY --from=build /app/target/ho-1.0-SNAPSHOT.jar app.jar
#22 CACHED

#23 [cauth 4/5] COPY . .
#23 CACHED

#24 [cauth 5/5] RUN mvn clean package -DskipTests
#24 CACHED

#25 [cauth 2/5] RUN apt-get update &&     apt-get install -y maven &&     rm -rf /var/lib/apt/lists/*
#25 CACHED

#26 [sp 4/5] COPY . .
#26 CACHED

#27 [cauth 3/5] WORKDIR /app
#27 CACHED

#28 [sp 5/5] RUN mvn clean package -DskipTests
#28 CACHED

#29 [ho] exporting to image
#29 exporting layers done
#29 writing image sha256:ed5f3a88e0a7fed794f4ba86d37c6efd51f25ed3d7371530996d710a7e2d1e8b done
#29 naming to docker.io/library/secure_software_assignment-ho done
#29 DONE 0.0s

#30 [cauth] exporting to image
#30 exporting layers done
#30 writing image sha256:97d9242be68c94e75c7f151a50c4d68f39529016a440fe97fc2e03ef7f00b490 done
#30 naming to docker.io/library/secure_software_assignment-cauth done
#30 DONE 0.0s

#31 [sp] exporting to image
#31 exporting layers done
#31 writing image sha256:da148129397fab7448ed0def9cea982834fa0a5e8d0b71dbc0e3f98275b90389 done
#31 naming to docker.io/library/secure_software_assignment-sp done
#31 DONE 0.0s

#32 [ho] resolving provenance for metadata file
#32 DONE 0.0s

#33 [cauth] resolving provenance for metadata file
#33 DONE 0.0s

#34 [sp] resolving provenance for metadata file
#34 DONE 0.0s
 secure_software_assignment-cauth  Built
 secure_software_assignment-sp  Built
 secure_software_assignment-ho  Built
 Network secure_software_assignment_java-network  Creating
 Network secure_software_assignment_java-network  Created
 Volume secure_software_assignment_sp_keystore  Creating
 Volume secure_software_assignment_sp_keystore  Created
 Volume secure_software_assignment_ho_keystore  Creating
 Volume secure_software_assignment_ho_keystore  Created
 Container cauth-container  Creating
 Container cauth-container  Created
 Container sp-container  Creating
 Container sp-container  Created
 Container ho-container  Creating
 Container ho-container  Created
 Container cauth-container  Starting
 Container cauth-container  Started
 Container sp-container  Starting
 Container sp-container  Started
 Container ho-container  Starting
 Container ho-container  Started
[INFO] Waiting for services to become reachable on published host ports...
[INFO] Waiting for localhost:8443
[INFO] Waiting for localhost:8444
[INFO] Waiting for localhost:8445
[INFO] Core services reachable
[INFO] --no-tmux specified; skipping tmux UI setup

==== P1_HONEST: Baseline Normal Flow ====
[INFO] Command: docker compose run --rm co
[INFO] Running CO (scenario=normal) envs: NONE
 Volume secure_software_assignment_co_keystore  Creating
 Volume secure_software_assignment_co_keystore  Created
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:04:42 UTC 2025
Valid until: Sat Dec 26 11:05:42 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 1 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 0ecf079e-569d-4b4e-8274-f94721199096
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:05:38.522280791Z
    validTo: 2025-12-26T19:05:38.522280791Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 196204d8-4591-44b9-8fa2-825a11bf53be
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=196204d8-4591-44b9-8fa2-825a11bf53be|verdict=OK|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|spotId=SPOT-A1|validFrom=2025-12-26T11:05:38.522280791Z|validTo=2025-12-26T19:05:38.522280791Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=196204d8-4591-44b9-8fa2-825a11bf53be|verdict=OK|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|spotId=SPOT-A1|validFrom=2025-12-26T11:05:38.522280791Z|validTo=2025-12-26T19:05:38.522280791Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/196204d8-4591-44b9-8fa2-825a11bf53be.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "fa02c960-be4a-4620-880d-f986b7607a23",
  "rootSignature": "YGPcF0/HkIOE+LNxDtHWmWyWE4D9k4XJtGG1ChzZJ1bii5HouvMXMcJ4dv8SzQ/fMi+Fr2hPg2idAOgrVndu45Y9jCkFxn68iE3vuGqcBBaCysiZz0FatN2g2VyK/VtwlKRzqCJ9hjL7SdRSomonanobpr31K5BaanLAjW50c3AmefxhDE13weyj2dKYwUXY7a1JKR6VoMDDbXYNox3IhIwbWoESLwg04MKIruBmwfneGf/3YWYFGFK/rpuJR8yUsl3p3YUNcxZt6A7Q4xuSoajBtxA21e8WZdf4cirffRxd4FKidyaoPt4fhm0tt2rPIKdO3zsR99djuEkfuI0z5g==",
  "root": "ehAVrcmlyIBEAqslSwK5THVUGS2K26KMsNlHUAw1CBE=",
  "x": 5,
  "tokens": [
    "2lZNY2q7Sc1E3Tfy/0sLOlzbve5RVRAwwNQuiN0UGNA=",
    "vEV+hxR6mj+YUepnJegne2Ct/IcIDLZ+IXbIPzuBh24=",
    "P2UcEhYKCuvhbbXNeaRSH6zkQMNHKC3MrdnZEdeGCRg=",
    "wneanz1dYBDE6tg3pTos9a027f5XpYT74rKD+5exbq4=",
    "ehAVrcmlyIBEAqslSwK5THVUGS2K26KMsNlHUAw1CBE="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: fa02c960-be4a-4620-880d-f986b7607a23
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 7A1015ADC9A5C8804402AB254B02B94C7554192D8ADBA28CB0D947500C350811
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: DA564D636ABB49CD...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: fa02c960-be4a-4620-880d-f986b7607a23
  Using SP-issued token batch, chainId=fa02c960-be4a-4620-880d-f986b7607a23
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: NONE
[M3] Normal payment flow (no negative scenarios)
→ Sending pay request to HO at ho:8445
← HO pay response:
{
  "startIndex": 0,
  "reservationId": "196204d8-4591-44b9-8fa2-825a11bf53be",
  "chainId": "fa02c960-be4a-4620-880d-f986b7607a23",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "196204d8-4591-44b9-8fa2-825a11bf53be",
    "signatureAlg": "SHA256withRSA",
    "chainId": "fa02c960-be4a-4620-880d-f986b7607a23",
    "availabilityId": "0ecf079e-569d-4b4e-8274-f94721199096",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "7240B8C5D52FBAB5E60E056751F658ECD92C38A518470D9B6365333B25DBB53F",
    "y": 5,
    "receiptId": "caa14751-1245-40e5-9d82-3f0b61b34482",
    "canonicalReceipt": "receiptId=caa14751-1245-40e5-9d82-3f0b61b34482|chainId=fa02c960-be4a-4620-880d-f986b7607a23|reservationId=196204d8-4591-44b9-8fa2-825a11bf53be|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:05:43.231846210Z|hoIdentity=HomeOwner",
    "receiptSignature": "FzuPkE7GieKiJk0nJl9RIokoHQ0NbrkOVww4hQo/Ej0gvBE1QPRyj4zeKJSDjWEd+TRzyk9bSqJH1GcaU9EGqqkgOgsHGXr3u8blh0JbjfFSg1vLLO+PWwGj5Gszn3XBBROnor/WLJ1ER0kVEE7bA5F8YjD5X/iLwUwK+m9SWTFaw1LYi8PNkbtoyumWaWjpa8VgYQbNM9ZBZ5s7Nd0MftOBxmYbmoDtMbJ44ZcuR90bAfh7SOGrS7EPklxue47OWnsWZLR0/xmofIxUyiE+FXvuyxgyzK8DQsB727nlWXmPGqWTBdWHohhzYWZ/gKMn+G+4XsOHbFKMwF8mOC4X9w==",
    "timestamp": "2025-12-26T11:05:43.231846210Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-26T11:05:43.272527585Z"
}
✓✓✓ PAYMENT ACCEPTED BY HO ✓✓✓

═══════════════════════════════════════════════════
M3.4: Verifying Payment Finalization Receipt
═══════════════════════════════════════════════════
[M3.4-VERIFY] Starting receipt verification...
[M3.4-VERIFY] Receipt ID: caa14751-1245-40e5-9d82-3f0b61b34482
[M3.4-VERIFY] Canonical data: receiptId=caa14751-1245-40e5-9d82-3f0b61b34482|chainId=fa02c960-be4a-4620-880d-f986b7607a23|reservationId=196204d8-4591-44b9-8fa2-825a11bf53be|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:05:43.231846210Z|hoIdentity=HomeOwner
[M3.4-VERIFY] Signature algorithm: SHA256withRSA
[M3.4-VERIFY] Validating consistency with local payment state...
[M3.4-VERIFY] ✓ Consistency validated
[M3.4-VERIFY]   chainId: fa02c960-be4a-4620-880d-f986b7607a23
[M3.4-VERIFY]   reservationId: 196204d8-4591-44b9-8fa2-825a11bf53be
[M3.4-VERIFY]   tokens spent: 5
[M3.4-VERIFY] Verifying SP signature (RSA-2048, SHA256withRSA)...
[M3.4-VERIFY] ✓ SP signature verified successfully
[M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
[M3.4-VERIFY] ✓ Integrity: Receipt has not been modified
[M3.4-VERIFY] Validating SP certificate to Root CA...
[M3.4-VERIFY] ✓ SP certificate is within validity period
[M3.4-VERIFY] ✓ SP certificate validated
[M3.4-VERIFY] Persisting receipt as immutable proof...
[M3.4-VERIFY] ✓ Receipt persisted: ./keystore/receipts/receipt_caa14751-1245-40e5-9d82-3f0b61b34482.json
[M3.4-VERIFY] ✓ Immutable proof stored for dispute resolution
[M3.4-VERIFY] ✓ Enables offline third-party verification
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] PAYMENT FINALITY ACHIEVED
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] ✓ SP signature verified (cryptographic proof)
[M3.4-VERIFY] ✓ Consistency validated (no substitution)
[M3.4-VERIFY] ✓ Immutable receipt stored (audit trail)
[M3.4-VERIFY] ✓ Non-repudiation guaranteed (SP cannot deny)
[M3.4-VERIFY] ✓ Dispute resolution enabled (third-party verification)
✓✓✓ PAYMENT FINALITY ESTABLISHED ✓✓✓
✓ SP-signed receipt verified
✓ Non-repudiation guaranteed
✓ Immutable proof of payment stored
═══════════════════════════════════════════════════

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 196204d8-4591-44b9-8fa2-825a11bf53be
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] normal: PASS (exit=0)

==== M4.1 TOKEN_TAMPER ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=TAMPER -e TAMPER_TOKEN_INDEX=0 -e TAMPER_BYTE_INDEX=0 co
[INFO] Running CO (scenario=token_tamper) envs: NEG_TEST_MODE=TAMPER TAMPER_TOKEN_INDEX=0 TAMPER_BYTE_INDEX=0
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:04:42 UTC 2025
Valid until: Sat Dec 26 11:05:42 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 1 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 0ecf079e-569d-4b4e-8274-f94721199096
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:05:38.522280791Z
    validTo: 2025-12-26T19:05:38.522280791Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 7c5a70d6-025f-41fa-aef0-9503bc4591c5
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=7c5a70d6-025f-41fa-aef0-9503bc4591c5|verdict=OK|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|spotId=SPOT-A1|validFrom=2025-12-26T11:05:38.522280791Z|validTo=2025-12-26T19:05:38.522280791Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=7c5a70d6-025f-41fa-aef0-9503bc4591c5|verdict=OK|availabilityId=0ecf079e-569d-4b4e-8274-f94721199096|spotId=SPOT-A1|validFrom=2025-12-26T11:05:38.522280791Z|validTo=2025-12-26T19:05:38.522280791Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/7c5a70d6-025f-41fa-aef0-9503bc4591c5.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "768c7fb7-0985-4925-8caa-34c6c5f41f1d",
  "rootSignature": "PWXhYvV7NVAqVlQOl+DiRCOe71yES07S7XbNzdhZ6uXuX4530cUF0rsnWoTxYdjJ2W8MhUZ+SQC4MinEmi3uFmjZ7EKg7Hs6x+7fAbgBm/tHQFqKE3oAKk29ncZgMYFQoq5AMJJFYyPhCSy5IWIrKtXaskEVq87wunylISCi2FYhqvx3UcGrpD6slsCHH55g9ewCF8L8PgQwDMFB06gv0B1ZmAyGuCSL8atjTb0HdgFml7vWazKft4xdiPfHq/AZjMlBw+QrVyH49iyQJBNq1zQxbO7O8LGeJMrwNLHGChQ+OpzIfxz3xUxdfmYUUuR2UPBOLpedc7SXD/z1NGds/A==",
  "root": "pNu/jpu3NMCU7jZ4ohapOz9+42jTEToLIFiC5iB1mHk=",
  "x": 5,
  "tokens": [
    "NmCq1z1RYI6gs7s9+712sfLIjzSVrT63ge9gID7CiHo=",
    "Dbtx0gJI1CLhVeAmnLmCvnwS17U+vA+0BYQDacrmTrc=",
    "P723lKDkgu6e9o4Y2Oi+trAWDRWuKi5/jP9Ptl9+Ovk=",
    "1f64/+8NT54UY43PFguZ+YBcl4e46W0iyYYyS/Pg6Ac=",
    "pNu/jpu3NMCU7jZ4ohapOz9+42jTEToLIFiC5iB1mHk="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 768c7fb7-0985-4925-8caa-34c6c5f41f1d
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: A4DBBF8E9BB734C094EE3678A216A93B3F7EE368D3113A0B205882E620759879
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: 3660AAD73D51608E...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 768c7fb7-0985-4925-8caa-34c6c5f41f1d
  Using SP-issued token batch, chainId=768c7fb7-0985-4925-8caa-34c6c5f41f1d
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: TAMPER
[M4.1] Tampering token[0] byte[0]
[M4.1] TOKEN TAMPERING ENABLED: flipped byte 0 of token index 0
[M4.1] Expect HO rejection (adjacency/anchor check failure)
→ Sending TAMPERED pay request to HO at ho:8445
← HO pay response:
{
  "reason": "security_violation",
  "code": "token_tampering_detected",
  "message": "adjacency check failed at i=0 - possible token tampering",
  "status": "error"
}
[M4.1] ✓ Expected rejection received from HO: security_violation

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 7c5a70d6-025f-41fa-aef0-9503bc4591c5
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] token_tamper: PASS (exit=0)

==== M4.2 REPLAY (Production): HO rejects locally ====
[INFO] Recreating HO with REPLAY_TEST_MODE=false
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[WARN] Could not verify HO env via docker inspect (may still be correct depending on compose env wiring)
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=REPLAY -e REPLAY_DELAY_MS=1000 co
[INFO] Running CO (scenario=replay_local_reject) envs: NEG_TEST_MODE=REPLAY REPLAY_DELAY_MS=1000
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:04:42 UTC 2025
Valid until: Sat Dec 26 11:05:42 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 2 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 07c99726-db9f-420e-b3a2-928d99dc68ba
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=07c99726-db9f-420e-b3a2-928d99dc68ba|verdict=OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=07c99726-db9f-420e-b3a2-928d99dc68ba|verdict=OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/07c99726-db9f-420e-b3a2-928d99dc68ba.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "d89e7610-b94c-48a8-b328-5571874ea7b8",
  "rootSignature": "SLlUxOgiXYi5ShW/hBLrW6Wn1DPIlkuaerkzkNcOb/MRLyr4QgmeoDyW8UnGvypOwkzCcXAyfKjHI37ywPsfES8wUITTyC3Ct6SAaEV0gbTT+k7ieX9GtGA1169jq0UysoOgsbwO/vDAHjyfur5YpMMTGzus0WpAjPZ1RLC9dHYaWZ4VmBAxXaBcztdDhQpjILFpY37Rp4/aQGj+ew9+ksBfs3JFMv8GFxF1zbMJo5Z4ZaKnRIyUG1EJuJcSAcyCOd3EcuIbeXy19Yz0/o+G9YzmFPjSyTh76buhkfFcLKENoSvu5JSu4amqH9DUhOlUxWMSSn/ZFR6DDQnvyZwh0Q==",
  "root": "5yVpWQsQZ+avgEzaJjPX2EzkU7xqBrnmA8REU8aqH3s=",
  "x": 5,
  "tokens": [
    "ZPaDzYQYRVnfclm28e8WbGgjL4zD2Gp2oPep6SYLOJc=",
    "7udJ/sI89VuVE5K51YmLKbG/n5DpgV92fe+/FcrG/Sc=",
    "23pRjy3S7zWXjELG3vAnMHNOsxk2pQm1PDAwQrdxZh8=",
    "i/lxhSBzWbXG/DWkTITY4aIGHoMAmf19zQ3RJa839wo=",
    "5yVpWQsQZ+avgEzaJjPX2EzkU7xqBrnmA8REU8aqH3s="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: d89e7610-b94c-48a8-b328-5571874ea7b8
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: E72569590B1067E6AF804CDA2633D7D84CE453BC6A06B9E603C44453C6AA1F7B
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: 64F683CD84184559...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: d89e7610-b94c-48a8-b328-5571874ea7b8
  Using SP-issued token batch, chainId=d89e7610-b94c-48a8-b328-5571874ea7b8
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "startIndex": 0,
  "reservationId": "07c99726-db9f-420e-b3a2-928d99dc68ba",
  "chainId": "d89e7610-b94c-48a8-b328-5571874ea7b8",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "07c99726-db9f-420e-b3a2-928d99dc68ba",
    "signatureAlg": "SHA256withRSA",
    "chainId": "d89e7610-b94c-48a8-b328-5571874ea7b8",
    "availabilityId": "04bed44d-51eb-4bde-8a50-d61ded006d2b",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "7240B8C5D52FBAB5E60E056751F658ECD92C38A518470D9B6365333B25DBB53F",
    "y": 5,
    "receiptId": "81708b02-2917-4d29-8ee4-057ef6c3259f",
    "canonicalReceipt": "receiptId=81708b02-2917-4d29-8ee4-057ef6c3259f|chainId=d89e7610-b94c-48a8-b328-5571874ea7b8|reservationId=07c99726-db9f-420e-b3a2-928d99dc68ba|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:06:11.073507598Z|hoIdentity=HomeOwner",
    "receiptSignature": "ae300WbM269Fa/fb+TwmlgkDP451c/FB4DvEH1GQkP17vr3ER0nE7NVx7WYyDL504oT6ZD1m++o/H6dID3kdWLRTxMkFC+I17uxBvYyEuIny5/+rTSdU0KWaNrfNz1baSuBhwjxrceLtsrR4F21Vrs+lua/lj7UPS9MBT+peyFm9pF7mtGlBRDlvy3ooqmoSHS8492T622giUyClH2SLRBu4+1OjFgzxJY03d0nYxh6osED+uTCCLeS4TNYU3655nVBtbRjJbepAYepwo/ZuG8tMl4LJhUxssZMHlaKKMIQfDMk4/vyv7Lg/Op11Ktx2aRGIW8SovyhvP5hrQDojgg==",
    "timestamp": "2025-12-26T11:06:11.073507598Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-26T11:06:11.119058807Z"
}

[M4.2] Waiting 1000 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}
✗ HO rejected payment: Settlement with SP failed - payment not accepted

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 07c99726-db9f-420e-b3a2-928d99dc68ba
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] replay_local_reject: PASS (exit=0)

==== M4.2 REPLAY (Test): HO forwards, SP rejects ====
[INFO] Recreating HO with REPLAY_TEST_MODE=true
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[INFO] HO env verified: REPLAY_TEST_MODE=true
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=REPLAY -e REPLAY_DELAY_MS=1000 co
[INFO] Running CO (scenario=replay_sp_reject) envs: NEG_TEST_MODE=REPLAY REPLAY_DELAY_MS=1000
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:04:42 UTC 2025
Valid until: Sat Dec 26 11:05:42 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 3 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 1e10bcde-ef03-499a-8b5d-2b1dad349b6f
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=1e10bcde-ef03-499a-8b5d-2b1dad349b6f|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=1e10bcde-ef03-499a-8b5d-2b1dad349b6f|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/1e10bcde-ef03-499a-8b5d-2b1dad349b6f.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "67fb24f0-0e2e-4771-ae79-76c4e85ed881",
  "rootSignature": "Cqajruc6HNHcVtf8RcSbD89ejh6BvO02JRA1ZZ6y53QbhNnWu+SPn5+EaGZX7R8rgo2PGzKRGEMJZX2UVaYsFJnVRdK2OV9g9Gie9KCQduzUujcs3ymlAYnVm87+ovP9VUgLOkrkCnuRhWNxDjisbcKLaTo4UhL8l8bpZV2qYkk2vFJruTAtczwpI2Th+AeKNXVCfTezcpNroam/MrrNnN0NrvDHCkgzXc1xeGJn+h2RHC6ppesNj/x1irn6j8o+P9ByjZ5gl1qg+ayayww0CSZBt2w/Afg4D3EmKKtDesYUFldb/Oz4OtU62u59F1cQOkrWn/zNOtW7UCUO7GW+wQ==",
  "root": "UuOCedk+fKHxhGHVcwgjoGujMyXW2hBGbvRo8hNHyVU=",
  "x": 5,
  "tokens": [
    "pz9MM+2qOTB9oIVFq8yMQNfCbBRbAKdnudtwfzJnWIc=",
    "+ljHyt9WcYwJyWAsckf14blzoM5D9jPRi9ozgUUv6LI=",
    "IEBHUKoovS4I305ql2QVkjWhHmwMP5xCg+ejD1iPSlQ=",
    "RJgQ1RbRhfQeKQu8DwmkXppHRHsOffeuOjNCxnchvPQ=",
    "UuOCedk+fKHxhGHVcwgjoGujMyXW2hBGbvRo8hNHyVU="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 67fb24f0-0e2e-4771-ae79-76c4e85ed881
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 52E38279D93E7CA1F18461D5730823A06BA33325D6DA10466EF468F21347C955
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: A73F4C33EDAA3930...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 67fb24f0-0e2e-4771-ae79-76c4e85ed881
  Using SP-issued token batch, chainId=67fb24f0-0e2e-4771-ae79-76c4e85ed881
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

[M4.2] Waiting 1000 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

═══════════════════════════════════════════════════════════
✗ HO rejected payment: Reservation verdict != OK
   RESERVATION HANDSHAKE COMPLETE
   Verdict: NOT_OK
   Non-repudiable proof stored: 1e10bcde-ef03-499a-8b5d-2b1dad349b6f
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] Recreating HO with REPLAY_TEST_MODE=false
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[WARN] Could not verify HO env via docker inspect (may still be correct depending on compose env wiring)
[INFO] [RESULT] replay_sp_reject: PASS (exit=0)

==== ROGUE_CO: BAD_CERT (MISSING) ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=BAD_CERT -e BAD_CERT_MODE=MISSING co
[INFO] Running CO (scenario=bad_cert_missing) envs: NEG_TEST_MODE=BAD_CERT BAD_CERT_MODE=MISSING
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [ROGUE_CO] NEGATIVE TEST MODE: BAD_CERT
  Sub-mode: MISSING
═══════════════════════════════════════════════════════════════
[ROGUE_CO] Testing rejection of CO without valid certificate
[ROGUE_CO] Mode: MISSING
[ROGUE_CO] MISSING mode: Skipping enrollment, no client certificate
[ROGUE_CO] Will attempt mTLS without presenting client certificate

[ROGUE_CO] Attempting mTLS connection to SP...
[ROGUE_CO] EXPECTED: Connection should FAIL
[ROGUE_CO] REASON: No client certificate presented (peer not authenticated)

[ROGUE_CO] Creating SSLContext WITHOUT client KeyManager
[ROGUE_CO] Connecting to SP at sp:8444
[ROGUE_CO] Starting TLS handshake...
[ROGUE_CO] TLS negotiation completed; validating mTLS acceptance...
[ROGUE_CO] Server authenticated: C=BE,O=Parking System,CN=ServiceProvider
[ROGUE_CO] Performing post-handshake proof (send request)...
[ROGUE_CO] Reading response to confirm mTLS acceptance...

╔═══════════════════════════════════════════════════════════════╗
║   [ROGUE_CO] ✓ SECURITY SUCCESS: Rogue CO REJECTED          ║
╚═══════════════════════════════════════════════════════════════╝
[ROGUE_CO] mTLS rejected by peer during client certificate validation!
[ROGUE_CO] Error type: SSLHandshakeException
[ROGUE_CO] Error message: Received fatal alert: bad_certificate
[ROGUE_CO] Analysis: SP rejected the client certificate (fatal alert: bad_certificate)
[ROGUE_CO] Reason: No client certificate presented (peer not authenticated)

[ROGUE_CO] VERIFICATION COMPLETE:
  ✓ CO skipped enrollment (no certificate obtained)
  ✓ CO attempted mTLS without client certificate
  ✓ SP rejected connection (peer not authenticated)
  ✓ System requires valid client certificate for mTLS
  ✓ System correctly enforces client certificate validation
  ✓ No bypass mechanisms available (strong security)

[ROGUE_CO] CONCLUSION: Rogue CO properly rejected!
[ROGUE_CO] The system is SECURE against unauthorized clients.

[INFO] [RESULT] bad_cert_missing: PASS (exit=0)

==== ROGUE_CO: BAD_CERT (SELF_SIGNED) ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=BAD_CERT -e BAD_CERT_MODE=SELF_SIGNED co
[INFO] Running CO (scenario=bad_cert_selfsigned) envs: NEG_TEST_MODE=BAD_CERT BAD_CERT_MODE=SELF_SIGNED
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [ROGUE_CO] NEGATIVE TEST MODE: BAD_CERT
  Sub-mode: SELF_SIGNED
═══════════════════════════════════════════════════════════════
[ROGUE_CO] Testing rejection of CO without valid certificate
[ROGUE_CO] Mode: SELF_SIGNED
[ROGUE_CO] SELF_SIGNED mode: Generating untrusted self-signed certificate
[ROGUE_CO] Generating RSA-2048 keypair for self-signed certificate...
[ROGUE_CO] Self-signed certificate created:
[ROGUE_CO]   BasicConstraints: CA=false
[ROGUE_CO]   KeyUsage: digitalSignature, keyEncipherment
[ROGUE_CO]   ExtendedKeyUsage: clientAuth
[ROGUE_CO] Certificate stored in keystore as PrivateKeyEntry
[ROGUE_CO] Keystore path: ./keystore/co_keystore.p12
[ROGUE_CO] Generated self-signed certificate:
  Subject: C=XX, O=Unauthorized, CN=ROGUE-CO-UNTRUSTED
  Issuer:  C=XX, O=Unauthorized, CN=ROGUE-CO-UNTRUSTED
  Serial:  309272438360951515243062591407762765177
[ROGUE_CO] ⚠ This certificate is NOT chained to trusted Root CA
[ROGUE_CO] ⚠ It is self-signed and will be rejected by services

[ROGUE_CO] Attempting mTLS connection to SP...
[ROGUE_CO] EXPECTED: Connection should FAIL
[ROGUE_CO] REASON: Self-signed cert not chained to Root CA (PKIX validation fails)

[ROGUE_CO] Creating SSLContext WITH self-signed certificate
[ROGUE_CO] Loading keystore to verify certificate availability...
[ROGUE_CO] Keystore loaded successfully:
[ROGUE_CO]   Type: PKCS12
[ROGUE_CO]   Path: ./keystore/co_keystore.p12
[ROGUE_CO]   Alias [1]: co_key
[ROGUE_CO]     Entry type: PrivateKeyEntry (has private key)
[ROGUE_CO]     Subject: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
[ROGUE_CO]     Issuer: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
[ROGUE_CO]     SHA-256: 13165A883484BA91DE7BA114E31FFB59...
[ROGUE_CO] Certificate is available and ready to be sent during TLS handshake
[ROGUE_CO] KeyManagers created: 1 manager(s)
[ROGUE_CO] KeyManager wrapped to force alias selection: co_key
[ROGUE_CO] SSLContext initialized with wrapped KeyManagers
[ROGUE_CO] Connecting to SP at sp:8444
[ROGUE_CO] Starting TLS handshake...
[ROGUE_CO] chooseClientAlias called - forcing alias: co_key
[ROGUE_CO] TLS negotiation completed; validating mTLS acceptance...
[ROGUE_CO] Server authenticated: C=BE,O=Parking System,CN=ServiceProvider
[ROGUE_CO] Performing post-handshake proof (send request)...
[ROGUE_CO] Reading response to confirm mTLS acceptance...

╔═══════════════════════════════════════════════════════════════╗
║   [ROGUE_CO] ✓ SECURITY SUCCESS: Rogue CO REJECTED          ║
╚═══════════════════════════════════════════════════════════════╝
[ROGUE_CO] mTLS rejected by peer during client certificate validation!
[ROGUE_CO] Error type: SSLHandshakeException
[ROGUE_CO] Error message: Received fatal alert: certificate_unknown

[ROGUE_CO] VERIFICATION COMPLETE:
  ✓ CO generated self-signed certificate
  ✓ CO attempted mTLS with untrusted certificate
  ✓ SP rejected connection (PKIX validation failed)
  ✓ Certificate not chained to trusted Root CA
  ✓ System correctly enforces client certificate validation
  ✓ No bypass mechanisms available (strong security)

[ROGUE_CO] CONCLUSION: Rogue CO properly rejected!
[ROGUE_CO] The system is SECURE against unauthorized clients.

[INFO] [RESULT] bad_cert_selfsigned: PASS (exit=0)

==== FORGED_RESERVATION: RESV_TAMPER FIELD_EDIT ====
 Container cauth-container  Running
 Container sp-container  Running
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RESV_TAMPER -e RESV_TAMPER_MODE=FIELD_EDIT co
[INFO] Running CO (scenario=resv_field_edit) envs: NEG_TEST_MODE=RESV_TAMPER RESV_TAMPER_MODE=FIELD_EDIT
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: FIELD_EDIT
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: FIELD_EDIT
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:06:07 UTC 2025
Valid until: Sat Dec 26 11:07:07 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 4 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #4
════════════════════════════════════════════════════════════
Availability ID: aeef9ee0-e21c-4ee2-bd38-2896d0dcbda5
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:37.014373278Z to 2025-12-26T19:06:37.014373278Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success

[RESV_TAMPER] ⚠ APPLYING TAMPERING (simulating attacker) ⚠
[RESV_TAMPER] Original signedData: reservationId=8f9f89b6-134e-4a06-a3a5-d9c3890ad264|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Original signature (Base64): sQHJLJLTcXq2ulFXbSok1v1FGs4EWCFM...
[RESV_TAMPER] FIELD_EDIT: Changed 'priceTokens=5' to 'priceTokens=1'
[RESV_TAMPER] Tampered signedData: reservationId=8f9f89b6-134e-4a06-a3a5-d9c3890ad264|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=1|coIdentity=CarOwner
[RESV_TAMPER] Signature unchanged: YES
[RESV_TAMPER] Proceeding to verification with tampered data...

  Reservation ID: 8f9f89b6-134e-4a06-a3a5-d9c3890ad264
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=8f9f89b6-134e-4a06-a3a5-d9c3890ad264|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=8f9f89b6-134e-4a06-a3a5-d9c3890ad264|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=1|coIdentity=CarOwner

╔═══════════════════════════════════════════════════════════════╗
║   [RESV_TAMPER] ✓ SECURITY SUCCESS                          ║
╚═══════════════════════════════════════════════════════════════╝
[RESV_TAMPER] Forged reservation detected!
[RESV_TAMPER] Failure reason: Signed data mismatch! Possible tampering or field modification.
[RESV_TAMPER] Tampering mode: FIELD_EDIT

[RESV_TAMPER] VERIFICATION COMPLETE:
  ✓ CO applied FIELD_EDIT tampering
  ✓ Signature verification correctly FAILED
  ✓ SecurityException thrown: Signed data mismatch! Possible tampering or field modification.
  ✓ CO failed closed (rejected forged reservation)
  ✓ HO identity binding enforced (cert fingerprint verified)
  ✓ No bypass mechanisms available

[RESV_TAMPER] CONCLUSION:
  SECURITY SUCCESS: Forged reservation detected
  (signature/canonical data mismatch)
  The system is SECURE against reservation tampering.

[INFO] [RESULT] resv_field_edit: PASS (exit=0)

==== FORGED_RESERVATION: RESV_TAMPER REORDER ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RESV_TAMPER -e RESV_TAMPER_MODE=REORDER co
[INFO] Running CO (scenario=resv_reorder) envs: NEG_TEST_MODE=RESV_TAMPER RESV_TAMPER_MODE=REORDER
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: REORDER
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: REORDER
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:06:07 UTC 2025
Valid until: Sat Dec 26 11:07:07 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 4 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #4
════════════════════════════════════════════════════════════
Availability ID: aeef9ee0-e21c-4ee2-bd38-2896d0dcbda5
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:37.014373278Z to 2025-12-26T19:06:37.014373278Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success

[RESV_TAMPER] ⚠ APPLYING TAMPERING (simulating attacker) ⚠
[RESV_TAMPER] Original signedData: reservationId=d09319b9-7940-4bda-a43d-591ea76fb62c|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Original signature (Base64): s1jv0lDuuGAxbBwGNfzVoUi9ekjoSMsR...
[RESV_TAMPER] REORDER: Swapped first two fields
[RESV_TAMPER] Tampered signedData: verdict=NOT_OK|reservationId=d09319b9-7940-4bda-a43d-591ea76fb62c|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Signature unchanged: YES
[RESV_TAMPER] Proceeding to verification with tampered data...

  Reservation ID: d09319b9-7940-4bda-a43d-591ea76fb62c
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=d09319b9-7940-4bda-a43d-591ea76fb62c|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  verdict=NOT_OK|reservationId=d09319b9-7940-4bda-a43d-591ea76fb62c|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner

╔═══════════════════════════════════════════════════════════════╗
║   [RESV_TAMPER] ✓ SECURITY SUCCESS                          ║
╚═══════════════════════════════════════════════════════════════╝
[RESV_TAMPER] Forged reservation detected!
[RESV_TAMPER] Failure reason: Signed data mismatch! Possible tampering or field modification.
[RESV_TAMPER] Tampering mode: REORDER

[RESV_TAMPER] VERIFICATION COMPLETE:
  ✓ CO applied REORDER tampering
  ✓ Signature verification correctly FAILED
  ✓ SecurityException thrown: Signed data mismatch! Possible tampering or field modification.
  ✓ CO failed closed (rejected forged reservation)
  ✓ HO identity binding enforced (cert fingerprint verified)
  ✓ No bypass mechanisms available

[RESV_TAMPER] CONCLUSION:
  SECURITY SUCCESS: Forged reservation detected
  (signature/canonical data mismatch)
  The system is SECURE against reservation tampering.

[INFO] [RESULT] resv_reorder: PASS (exit=0)

==== FORGED_RESERVATION: RESV_TAMPER SIG_FLIP ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RESV_TAMPER -e RESV_TAMPER_MODE=SIG_FLIP co
[INFO] Running CO (scenario=resv_sig_flip) envs: NEG_TEST_MODE=RESV_TAMPER RESV_TAMPER_MODE=SIG_FLIP
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: SIG_FLIP
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: SIG_FLIP
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:06:07 UTC 2025
Valid until: Sat Dec 26 11:07:07 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 4 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #4
════════════════════════════════════════════════════════════
Availability ID: aeef9ee0-e21c-4ee2-bd38-2896d0dcbda5
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:37.014373278Z to 2025-12-26T19:06:37.014373278Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success

[RESV_TAMPER] ⚠ APPLYING TAMPERING (simulating attacker) ⚠
[RESV_TAMPER] Original signedData: reservationId=728fe1f0-9a29-4b8c-895c-e4afdf421f10|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Original signature (Base64): yxZACbkcHH5zzxmmRsdIOPmkdmFC/bR0...
[RESV_TAMPER] SIG_FLIP: Flipped 1 bit in signature byte 0
[RESV_TAMPER] Tampered signature (Base64): yhZACbkcHH5zzxmmRsdIOPmkdmFC/bR0...
[RESV_TAMPER] Signature unchanged: NO (tampered)
[RESV_TAMPER] Proceeding to verification with tampered data...

  Reservation ID: 728fe1f0-9a29-4b8c-895c-e4afdf421f10
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=728fe1f0-9a29-4b8c-895c-e4afdf421f10|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=728fe1f0-9a29-4b8c-895c-e4afdf421f10|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format

╔═══════════════════════════════════════════════════════════════╗
║   [RESV_TAMPER] ✓ SECURITY SUCCESS                          ║
╚═══════════════════════════════════════════════════════════════╝
[RESV_TAMPER] Forged reservation detected!
[RESV_TAMPER] Failure reason: HO signature verification FAILED! Response may be forged.
[RESV_TAMPER] Tampering mode: SIG_FLIP

[RESV_TAMPER] VERIFICATION COMPLETE:
  ✓ CO applied SIG_FLIP tampering
  ✓ Signature verification correctly FAILED
  ✓ SecurityException thrown: HO signature verification FAILED! Response may be forged.
  ✓ CO failed closed (rejected forged reservation)
  ✓ HO identity binding enforced (cert fingerprint verified)
  ✓ No bypass mechanisms available

[RESV_TAMPER] CONCLUSION:
  SECURITY SUCCESS: Forged reservation detected
  (signature/canonical data mismatch)
  The system is SECURE against reservation tampering.

[INFO] [RESULT] resv_sig_flip: PASS (exit=0)

==== FORGED_RESERVATION: RESV_TAMPER DROP_FIELD ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RESV_TAMPER -e RESV_TAMPER_MODE=DROP_FIELD co
[INFO] Running CO (scenario=resv_drop_field) envs: NEG_TEST_MODE=RESV_TAMPER RESV_TAMPER_MODE=DROP_FIELD
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: DROP_FIELD
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: DROP_FIELD
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:06:07 UTC 2025
Valid until: Sat Dec 26 11:07:07 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 4 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #4
════════════════════════════════════════════════════════════
Availability ID: aeef9ee0-e21c-4ee2-bd38-2896d0dcbda5
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:37.014373278Z to 2025-12-26T19:06:37.014373278Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success

[RESV_TAMPER] ⚠ APPLYING TAMPERING (simulating attacker) ⚠
[RESV_TAMPER] Original signedData: reservationId=2810c37c-317c-4b79-a070-a75a1a320356|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Original signature (Base64): coHpI8nrjScU6XAoCmdpwPaI140cY0tH...
[RESV_TAMPER] DROP_FIELD: Removed 'coIdentity' field
[RESV_TAMPER] Tampered signedData: reservationId=2810c37c-317c-4b79-a070-a75a1a320356|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5
[RESV_TAMPER] Signature unchanged: YES
[RESV_TAMPER] Proceeding to verification with tampered data...

  Reservation ID: 2810c37c-317c-4b79-a070-a75a1a320356
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=2810c37c-317c-4b79-a070-a75a1a320356|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=2810c37c-317c-4b79-a070-a75a1a320356|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5

╔═══════════════════════════════════════════════════════════════╗
║   [RESV_TAMPER] ✓ SECURITY SUCCESS                          ║
╚═══════════════════════════════════════════════════════════════╝
[RESV_TAMPER] Forged reservation detected!
[RESV_TAMPER] Failure reason: Signed data mismatch! Possible tampering or field modification.
[RESV_TAMPER] Tampering mode: DROP_FIELD

[RESV_TAMPER] VERIFICATION COMPLETE:
  ✓ CO applied DROP_FIELD tampering
  ✓ Signature verification correctly FAILED
  ✓ SecurityException thrown: Signed data mismatch! Possible tampering or field modification.
  ✓ CO failed closed (rejected forged reservation)
  ✓ HO identity binding enforced (cert fingerprint verified)
  ✓ No bypass mechanisms available

[RESV_TAMPER] CONCLUSION:
  SECURITY SUCCESS: Forged reservation detected
  (signature/canonical data mismatch)
  The system is SECURE against reservation tampering.

[INFO] [RESULT] resv_drop_field: PASS (exit=0)

==== RECEIPT_TAMPER ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RECEIPT_TAMPER co
[INFO] Running CO (scenario=receipt_tamper) envs: NEG_TEST_MODE=RECEIPT_TAMPER
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:06:07 UTC 2025
Valid until: Sat Dec 26 11:07:07 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 4 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:06.213863721Z to 2025-12-26T19:06:06.213863721Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0ecf079e-569d-4b4e-8274-f94721199096
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:05:38.522280791Z to 2025-12-26T19:05:38.522280791Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 90ead048-f938-4c99-9ceb-be439ebd16cc
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:21.738170104Z to 2025-12-26T19:06:21.738170104Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
Availability #4
════════════════════════════════════════════════════════════
Availability ID: aeef9ee0-e21c-4ee2-bd38-2896d0dcbda5
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:06:37.014373278Z to 2025-12-26T19:06:37.014373278Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:04:38 UTC 2025
  Valid until: Sat Dec 26 11:05:38 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 26BC02C465F19D69...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 26BC02C465F19D6937BE61C6FC4CADD7...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 04bed44d-51eb-4bde-8a50-d61ded006d2b

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
  Received fingerprint: 26BC02C465F19D6937BE61C6FC4CADD79FC702BE2B5A2C6E1E8CEDB9AD0BDB1B
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 04bed44d-51eb-4bde-8a50-d61ded006d2b
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:06:06.213863721Z
    validTo: 2025-12-26T19:06:06.213863721Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 55239eda-a41e-467e-8abe-b5d66270d92e
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=55239eda-a41e-467e-8abe-b5d66270d92e|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=55239eda-a41e-467e-8abe-b5d66270d92e|verdict=NOT_OK|availabilityId=04bed44d-51eb-4bde-8a50-d61ded006d2b|spotId=SPOT-A1|validFrom=2025-12-26T11:06:06.213863721Z|validTo=2025-12-26T19:06:06.213863721Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/55239eda-a41e-467e-8abe-b5d66270d92e.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "373c436e-4b6f-479c-a21b-b06afc777eaa",
  "rootSignature": "PxFPwwVE1tw8Nja2qYJ+u/+ilOP1AMTT0hXCm4ruTB0YGjYw+njAHSsXG6M+udW/gVnnllcpGSbB1upfZKzu8MrpSWC1c0LpNFFHlgbv5n5b9TfdqNYYzYqYzBG11P42i417d83wal//JeVov1cWaexyhCmLav7BGA1MJ33vMI6/OcM5E3rdWGIo4S/TRVh16/T4Fpi0eiqN6MagXld6LgqFTNQp8+XzFC7OJCFOQ6oWxMfrAAuntr/mS/WzGwvyrR8xM4wp2zK412h6GrsvhxBRJGhmqHjRqtXh3B8fEKYtM1r2M/R9XNOQyA7UsvE7bwLX7Pc7+Gh230m14OkTDA==",
  "root": "cwTtQEofQm5uegNXydFhEa8sGitpHp1rl4Y9UuNkTso=",
  "x": 5,
  "tokens": [
    "rXLAMsjWnpRKMxfmOYFGnKuOrMt11/gcVFRsQAUz0O0=",
    "zLfzIWI2e6c+iMGsokW9S26TbrrEL+dRcDciaTaGBss=",
    "wB0N9Ne5AA0e/PRdG+a1nSg/EEdhF3hcHKsnpTkwXA8=",
    "lAi31NIlT1kiEWNIOpixi+j/6DwGFxsGubi8ZdjUiCE=",
    "cwTtQEofQm5uegNXydFhEa8sGitpHp1rl4Y9UuNkTso="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 373c436e-4b6f-479c-a21b-b06afc777eaa
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 7304ED404A1F426E6E7A0357C9D16111AF2C1A2B691E9D6B97863D52E3644ECA
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: AD72C032C8D69E94...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 373c436e-4b6f-479c-a21b-b06afc777eaa
  Using SP-issued token batch, chainId=373c436e-4b6f-479c-a21b-b06afc777eaa
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: RECEIPT_TAMPER
[M3] Normal payment flow (no negative scenarios)
→ Sending pay request to HO at ho:8445
✗ HO rejected payment: Reservation verdict != OK
← HO pay response:
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: NOT_OK
   Non-repudiable proof stored: 55239eda-a41e-467e-8abe-b5d66270d92e
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] receipt_tamper: PASS (exit=0)

==== CAuth-1 FAKE_CAUTH: Rogue Intermediate ====
[INFO] Clearing CO keystore to force fresh enrollment with fake-cauth
[INFO] Starting fake-cauth service
#1 [internal] load local bake definitions
#1 reading from stdin 629B done
#1 DONE 0.0s

#2 [internal] load build definition from Dockerfile
#2 transferring dockerfile: 523B done
#2 DONE 0.0s

#3 [internal] load metadata for docker.io/library/eclipse-temurin:17-jdk
#3 DONE 1.4s

#4 [internal] load .dockerignore
#4 transferring context: 2B done
#4 DONE 0.0s

#5 [1/5] FROM docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778
#5 resolve docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778 done
#5 DONE 0.0s

#6 [internal] load build context
#6 transferring context: 1.26kB done
#6 DONE 0.0s

#7 [2/5] RUN apt-get update &&     apt-get install -y maven &&     rm -rf /var/lib/apt/lists/*
#7 CACHED

#8 [3/5] WORKDIR /app
#8 CACHED

#9 [4/5] COPY . .
#9 CACHED

#10 [5/5] RUN mvn clean package -DskipTests
#10 CACHED

#11 exporting to image
#11 exporting layers done
#11 writing image sha256:b782db31d9fbb1f2f04b90a1fb06f9815620cf184552b73af4caa8ddc7110ab0 done
#11 naming to docker.io/library/secure_software_assignment-fake-cauth done
#11 DONE 0.0s

#12 resolving provenance for metadata file
#12 DONE 0.0s
 secure_software_assignment-fake-cauth  Built
 Container fake-cauth-container  Creating
 Container fake-cauth-container  Created
 Container fake-cauth-container  Starting
 Container fake-cauth-container  Started
[INFO] fake-cauth published port for 8443 is localhost:8543
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=FAKE_CAUTH -e CAUTH_HOST=fake-cauth co
[INFO] Running CO (scenario=fake_cauth) envs: NEG_TEST_MODE=FAKE_CAUTH CAUTH_HOST=fake-cauth
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
[CAuth-1] TEST MODE: Connecting to fake-cauth (skipping server cert validation)
[CAuth-1] NOTE: This is for testing only - allows enrollment with rogue CA
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: C=XX,O=Fake Authority,CN=ROGUE-CA-DO-NOT-TRUST
Valid from: Fri Dec 26 11:07:17 UTC 2025
Valid until: Sat Dec 26 11:08:17 UTC 2026

═══════════════════════════════════════════════════════════════
  [CAuth-1] NEGATIVE TEST MODE: FAKE_CAUTH
═══════════════════════════════════════════════════════════════
[CAuth-1] Testing rejection of rogue intermediate CA certificate
[CAuth-1] Enrolled with: fake-cauth:8443
[CAuth-1] Certificate Details:
  Subject: C=BE, O=Parking System, CN=CarOwner
  Issuer:  C=XX, O=Fake Authority, CN=ROGUE-CA-DO-NOT-TRUST
  Serial:  58877292287328516346549019974194504678
[CAuth-1] ⚠ DETECTED: Certificate issued by ROGUE CA!
[CAuth-1] ⚠ This certificate is NOT chained to the trusted Root CA

[CAuth-1] Attempting mTLS connection to SP...
[CAuth-1] EXPECTED: Connection should FAIL with PKIX validation error
[CAuth-1] REASON: SP truststore only contains real Root CA, not rogue CA

Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...

╔═══════════════════════════════════════════════════════════════╗
║   [CAuth-1] ✓ SECURITY SUCCESS: Rogue CA Certificate REJECTED║
╚═══════════════════════════════════════════════════════════════╝
[CAuth-1] mTLS connection to SP failed as expected!
[CAuth-1] Error type: SSLHandshakeException
[CAuth-1] Error message: Received fatal alert: bad_certificate

[CAuth-1] VERIFICATION COMPLETE:
  ✓ CO successfully enrolled with fake-cauth
  ✓ CO received certificate signed by rogue CA
  ✓ CO stored certificate in keystore (normal behavior)
  ✓ SP rejected mTLS connection (PKIX validation failed)
  ✓ Certificate chain does not terminate at trusted Root CA
  ✓ System correctly enforces trust anchor validation

[CAuth-1] CONCLUSION: Rogue intermediate CA properly rejected!
[CAuth-1] The system is SECURE against untrusted CA attacks.

 Container fake-cauth-container  Stopping
 Container fake-cauth-container  Stopped
[INFO] [RESULT] fake_cauth: PASS (exit=0)

==== Test Summary ====
./start.sh: line 579: printf: - : invalid option
printf: usage: printf [-v var] format [arguments]
