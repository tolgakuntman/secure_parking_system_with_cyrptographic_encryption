 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Thu Dec 25 22:53:16 UTC 2025
Valid until: Fri Dec 25 22:54:16 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 3 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 4de265e1-73a6-473e-8ff0-9e927153a2d4
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-25T22:54:11.920735980Z to 2025-12-26T06:54:11.920735980Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Thu Dec 25 22:53:11 UTC 2025
  Valid until: Fri Dec 25 22:54:11 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: AAB9D74CC14D252F...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: AAB9D74CC14D252F2E92169D386BB399...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 73a60274-8fc9-4869-aa4d-10ec379b7a42
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-25T22:54:48.700832152Z to 2025-12-26T06:54:48.700832152Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Thu Dec 25 22:53:11 UTC 2025
  Valid until: Fri Dec 25 22:54:11 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: AAB9D74CC14D252F...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: AAB9D74CC14D252F2E92169D386BB399...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 361f397b-703e-4e60-93df-a3fe69afc227
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-25T22:55:09.191190008Z to 2025-12-26T06:55:09.191190008Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Thu Dec 25 22:53:11 UTC 2025
  Valid until: Fri Dec 25 22:54:11 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: AAB9D74CC14D252F...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: AAB9D74CC14D252F2E92169D386BB399...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 4de265e1-73a6-473e-8ff0-9e927153a2d4

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: AAB9D74CC14D252F2E92169D386BB3996BE85D44FC4637FB09644E07283E0B91
  Received fingerprint: AAB9D74CC14D252F2E92169D386BB3996BE85D44FC4637FB09644E07283E0B91
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 4de265e1-73a6-473e-8ff0-9e927153a2d4
    spotId: SPOT-A1
    validFrom: 2025-12-25T22:54:11.920735980Z
    validTo: 2025-12-26T06:54:11.920735980Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 0ca81af8-07ed-41ce-acef-ef5765606856
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=0ca81af8-07ed-41ce-acef-ef5765606856|verdict=NOT_OK|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|spotId=SPOT-A1|validFrom=2025-12-25T22:54:11.920735980Z|validTo=2025-12-26T06:54:11.920735980Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=0ca81af8-07ed-41ce-acef-ef5765606856|verdict=NOT_OK|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|spotId=SPOT-A1|validFrom=2025-12-25T22:54:11.920735980Z|validTo=2025-12-26T06:54:11.920735980Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/0ca81af8-07ed-41ce-acef-ef5765606856.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "eeb5e386-32c1-4f98-b6af-51a49a57a8ca",
  "rootSignature": "FglKpbcVGc7NjgbuYJ62oKF8EKHJwPSaHjjNNNDCa/Tokm8di8EwDZNcrzKME6d2YsbiRwOePrq+9voP6czj8upeKJ9LVFfKOfNMU+IOmT0dRs5a8rWam0cv3nHP6RlYo9fE7YqBH1KQDsrXO8/LM+y1Gntuw2isAXceNUhdTVwrR4lhdpUffTgvwkCGrF8jCddN3ZJVcrSLsXu4ny2EyPhhwPmO4tGfv3KgW2cPyFOTZ9dwkvwxtiH2ZfpUdc8SImdLL7YULQukGokwze16YKjpQFoNOWskS1c7jsW6fJtqCTsFu2FNw22bKxqChSCnOrQZOcWh/cnccO5BlS4vpQ==",
  "root": "veM2cUrCdY4HGaD4AsgRxJS9q6eNIMhpqx7uXQmnMqw=",
  "x": 5,
  "tokens": [
    "fYVnu4+ScpXcFiGAwKDkeMdwM1g4xvXs9QWlsvcc1D4=",
    "3UyPKe1jI80+8rEeZwf0jFBSEFZ6KSk1taoNEnTlXi0=",
    "Fjf5NXQxjvb5aUUSR3jj28A1cfuCDlVwJ/JJeinqhdM=",
    "QKRYJHVohdsS+r3796d9uWzwxNRXw0qVku2Vcct78YI=",
    "veM2cUrCdY4HGaD4AsgRxJS9q6eNIMhpqx7uXQmnMqw="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: eeb5e386-32c1-4f98-b6af-51a49a57a8ca
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: BDE336714AC2758E0719A0F802C811C494BDABA78D20C869AB1EEE5D09A732AC
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: 7D8567BB8F927295...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: eeb5e386-32c1-4f98-b6af-51a49a57a8ca
  Using SP-issued token batch, chainId=eeb5e386-32c1-4f98-b6af-51a49a57a8ca
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

[M4.2] Waiting 1000 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
✗ HO rejected payment: Reservation verdict != OK
   Verdict: NOT_OK
   Non-repudiable proof stored: 0ca81af8-07ed-41ce-acef-ef5765606856
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
