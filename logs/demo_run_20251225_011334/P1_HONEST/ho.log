[HO][INFO][NONE] Waiting for CAuth and SP to start...
[HO][INFO][NONE] 
=== Home Owner (HO) Starting ===
[HO][INFO][NONE] No existing certificate found, enrolling with CAuth...
[HO][INFO][NONE] 
=== Enrollment Phase ===
[HO][INFO][NONE] → Generating RSA-2048 key pair...
[HO][INFO][NONE] ...
[HO][INFO][NONE] → Creating Certificate Signing Request (CSR)...
[HO][INFO][NONE] ✓ CSR created with subject: C=BE,O=Parking System,CN=HomeOwner
[HO][INFO][NONE] → Submitting CSR to CAuth at cauth:8443...
[HO][INFO][NONE] ...
[HO][INFO][NONE] ...
[HO][INFO][NONE]   Serial: EB3CE678CD540D5E29DB678638DA5D
[HO][INFO][NONE]   Issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] ...
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
╔═══════════════════════════════════════════╗
[HO][INFO][NONE] ║   HO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════╝
[HO][INFO][NONE] Subject: CN=HomeOwner,O=Parking System,C=BE
[HO][INFO][NONE] Issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] Valid from: Wed Dec 24 22:12:45 UTC 2025
[HO][INFO][NONE] Valid until: Thu Dec 24 22:13:45 UTC 2026
[HO][INFO][NONE] 
=== Publishing Parking Availability to SP ===
[HO][INFO][NONE] ...
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE]   SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[HO][INFO][NONE] [M3.2] SP public key cached from mTLS handshake
[HO][INFO][NONE] 
→ Publishing availability to SP...
[HO][INFO][NONE]   Spot ID: SPOT-A1
[HO][INFO][NONE]   Valid from: 2025-12-24T22:13:45.562387240Z
[HO][INFO][NONE]   Valid to: 2025-12-25T06:13:45.562387240Z
[HO][INFO][NONE]   Price: 5 tokens
[HO][INFO][NONE]   Location: Downtown-North
[HO][INFO][NONE] 
← Received response from SP
[HO][INFO][NONE] 
╔═══════════════════════════════════════════╗
[HO][INFO][NONE] ║   AVAILABILITY PUBLISHED SUCCESSFULLY     ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════╝
[HO][INFO][NONE] Availability ID: 5e6ed5f6-a38d-406f-93a0-d87229cc32ae
[HO][INFO][NONE] Message: Parking availability published successfully
[HO][INFO][NONE] 
=== Starting HO Reservation & Payment Server ===
[HO][INFO][NONE] 
╔═══════════════════════════════════════════════════════════╗
[HO][INFO][NONE] ║   HO RESERVATION SERVER CRYPTOGRAPHIC BASELINE           ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════════════════════╝
[HO][INFO][NONE] Version: 2025-12-22 (Milestone 2.4 - Reservation Handshake)
[HO][INFO][NONE] ✓ Enabled TLS protocols: [TLSv1.3, TLSv1.2]
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
[HO][INFO][NONE] === HO Reservation Server Configuration ===
[HO][INFO][NONE] Server listening on port: 8445
[HO][INFO][NONE] Server certificate subject: CN=HomeOwner,O=Parking System,C=BE
[HO][INFO][NONE] Server certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] RSA key size: 2048 bits
[HO][INFO][NONE] Signature algorithm: SHA256withRSA
[HO][INFO][NONE] mTLS enforcement: ENABLED (CO certificates REQUIRED)
[HO][INFO][NONE] 
[HO][INFO][NONE] ...
[HO][INFO][NONE] ==========================================

[HO][INFO][NONE] 
=== Inbound Reservation Request ===
[HO][INFO][NONE] 
║   CO AUTHENTICATED VIA mTLS               ║
[HO][INFO][NONE] CO CN: CarOwner
[HO][INFO][NONE] CO address: /172.20.0.13:33416
[HO][INFO][NONE] CO certificate subject: C=BE,O=Parking System,CN=CarOwner
[HO][INFO][NONE] CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] CO certificate serial: 1CFEF6A6C9CA8B79A1BF9815EE8C4FC7
[HO][INFO][NONE] 
[HO][INFO][NONE] TLS Session Details:
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] ═══════════════════════════════════════════

[HO][INFO][NONE] Received request from CarOwner:
[HO][INFO][NONE] {
  "priceTokens": 5,
  "method": "requestReservation",
  "availabilityId": "5e6ed5f6-a38d-406f-93a0-d87229cc32ae",
  "spotId": "SPOT-A1",
  "validFrom": "2025-12-24T22:13:45.562387240Z",
  "validTo": "2025-12-25T06:13:45.562387240Z",
  "coIdentity": "CarOwner"
}
[HO][INFO][NONE] 
=== Processing Reservation Request (Milestone 2.4) ===
[HO][INFO][NONE]   Availability ID: 5e6ed5f6-a38d-406f-93a0-d87229cc32ae
[HO][INFO][NONE]   Spot ID: SPOT-A1
[HO][INFO][NONE]   Valid: 2025-12-24T22:13:45.562387240Z to 2025-12-25T06:13:45.562387240Z
[HO][INFO][NONE]   Price: 5 tokens
[HO][INFO][NONE]   Requested CO Identity: CarOwner
[HO][INFO][NONE] ✓ CO identity verified: CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE] Generated Reservation ID: bb5dec74-2100-4d28-ac66-7a9d42964fa2
[HO][INFO][NONE] 
─ Generating Cryptographic Signature ─
[HO][INFO][NONE] Canonical data to sign:
[HO][INFO][NONE]   reservationId=bb5dec74-2100-4d28-ac66-7a9d42964fa2|verdict=OK|availabilityId=5e6ed5f6-a38d-406f-93a0-d87229cc32ae|spotId=SPOT-A1|validFrom=2025-12-24T22:13:45.562387240Z|validTo=2025-12-25T06:13:45.562387240Z|priceTokens=5|coIdentity=CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE]   Algorithm: SHA256withRSA
[HO][INFO][NONE]   Signature length: 256 bytes
[HO][INFO][NONE]   Signature (Base64): bK5Qq7+E533s4DAQ7PyA7ukjitfVpu4d...
[HO][INFO][NONE] 
╔═══════════════════════════════════════════════════════════╗
[HO][INFO][NONE] ║   RESERVATION DECISION: OK
[HO][INFO][NONE] ╚═══════════════════════════════════════════════════════════╝
[HO][INFO][NONE] Reservation ID: bb5dec74-2100-4d28-ac66-7a9d42964fa2
[HO][INFO][NONE] CO Identity: CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
Sent signed reservation response:
[HO][INFO][NONE] {
  "hoIdentity": "HomeOwner",
  "reservationId": "bb5dec74-2100-4d28-ac66-7a9d42964fa2",
  "signatureAlg": "SHA256withRSA",
  "signature": "bK5Qq7+E533s4DAQ7PyA7ukjitfVpu4dr1LEa4ey/Bk0sIhXoOQjD8PcUEvCk+0n7XXKNtlT3SmgCK9OJbR4ClFbH8ANvwXVceFZX26SR1ZhsRT66kTyQPG9TJl7mcjkEzXJhbrNUZg5UuBNT2zVZW0aJZA8LPrcrsTjBzE9QLulFFF1kDRK0j705zsFbHGF4bvDdfFzX1RFcztNNQiQA0seUrGptJb2vw/L90h1IHL9kApZH2SXceXejhaMuHmz0GRh/v3wvhvBxPyLorr+T/7osAeuAaDbkRF6YX1t6NwVHxTsjyi/d6EJBqnfg7jRxTJK3AnIwZXOEqi2tS0f9Q==",
  "signedData": "reservationId=bb5dec74-2100-4d28-ac66-7a9d42964fa2|verdict=OK|availabilityId=5e6ed5f6-a38d-406f-93a0-d87229cc32ae|spotId=SPOT-A1|validFrom=2025-12-24T22:13:45.562387240Z|validTo=2025-12-25T06:13:45.562387240Z|priceTokens=5|coIdentity=CarOwner",
  "verdict": "OK",
  "status": "success"
}
[HO][INFO][NONE] 
CarOwner disconnected

[HO][INFO][NONE] 
=== Inbound Reservation Request ===
[HO][INFO][NONE] 
║   CO AUTHENTICATED VIA mTLS               ║
[HO][INFO][NONE] CO CN: CarOwner
[HO][INFO][NONE] CO address: /172.20.0.13:33430
[HO][INFO][NONE] CO certificate subject: C=BE,O=Parking System,CN=CarOwner
[HO][INFO][NONE] CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] CO certificate serial: 1CFEF6A6C9CA8B79A1BF9815EE8C4FC7
[HO][INFO][NONE] 
[HO][INFO][NONE] TLS Session Details:
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] ═══════════════════════════════════════════

[HO][INFO][NONE] Received request from CarOwner:
[HO][INFO][NONE] {
  "startIndex": 0,
  "method": "pay",
  "reservationId": "bb5dec74-2100-4d28-ac66-7a9d42964fa2",
  "chainId": "c24c7490-03d8-4fc1-993a-573ba2157455",
  "rootSignature": "j3dtNM1qHt64fFpBpwBQ8FRwTGO565uiHuxPOw2Lc40ZUsD9BJbKe0lQpFHsUFe4P7kd046RGvWE9S+urW9d5a3JHxYMHlvEq+c5Aup317mqkHEbFeSKKHlczOXm74FpiATnXBnV/X9c0PFzeJcgnTMsJPHWwVbgUasznlQcygOUGLo1a/VNLolHZzs75oAJDHrhHffpAQgjW14c9ZywPy1I2pr6cBRenGcLCOJXboHCdz5UPVk9fK3MDfFsoDAYuGwUBhJoluNwmpU8JneruKWK48mT3rphYohCpCvEof5mRn9gJ2mRrbRCsTmjo6FXIm4ApQc/kvvdZW/DpqiiSg==",
  "root": "5D2MBpsOnn8elTr8cbIXlj1KhiZM5lgBgQmwzkdrMgI=",
  "x": 5,
  "tokensToSpend": [
    "hd/whdB93YGzXXoh4/hYHjrjddrZ3l6zlOB0phZG8HA=",
    "detos1aQjm3YVKx9vcq4bhjke3qq85EjXyPgyNOCZ94=",
    "xtVGEUeBPI1dRuqtdzvhZYIgNJfVyPEyHLsR/cBZnWk=",
    "IsX8iLSISGf1NqY9C7ZTD8vvbS+ytEG21CWuC6luBDU=",
    "5D2MBpsOnn8elTr8cbIXlj1KhiZM5lgBgQmwzkdrMgI="
  ]
}
[HO][INFO][NONE] [M3.2] root signature verified via cached SP public key
[HO][INFO][NONE] [M3.2] policy checks passed (reservation verdict OK, token count matches)
[HO][INFO][NONE] [PAY] received from CarOwner
[HO][INFO][NONE] [PAY]   reservationId=bb5dec74-2100-4d28-ac66-7a9d42964fa2
[HO][INFO][NONE] [PAY]   chainId=c24c7490-03d8-4fc1-993a-573ba2157455
[HO][INFO][NONE] [PAY]   tokenCount=5
[HO][INFO][NONE] [PAY]   startIndex=0
[HO][INFO][NONE] [PAY]   x=5
[HO][INFO][NONE] [PAY]   Hash-chain verification: SUCCESS
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] Preparing Settlement Request to SP
[HO][INFO][NONE] [SETTLE]   chainId: c24c7490-03d8-4fc1-993a-573ba2157455
[HO][INFO][NONE] [SETTLE]   reservationId: bb5dec74-2100-4d28-ac66-7a9d42964fa2
[HO][INFO][NONE] [SETTLE]   y (tokens spent): 5
[HO][INFO][NONE] [SETTLE]   newLastSpentIndex: 5
[HO][INFO][NONE] [SETTLE]   x (chain length): 5
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] ✓ TLS hardening applied (TLS 1.3/1.2, AEAD ciphers only)
[HO][INFO][NONE] [SETTLE] Initiating explicit TLS handshake...
[HO][INFO][NONE] [SETTLE] ✓ TLS handshake completed successfully
[HO][INFO][NONE] [SETTLE]   Protocol: TLSv1.3
[HO][INFO][NONE] [SETTLE]   Cipher Suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] [SETTLE] ✓ SP certificate verified: C=BE,O=Parking System,CN=ServiceProvider
[HO][INFO][NONE] [SETTLE] → Settlement request sent to SP
[HO][INFO][NONE] [SETTLE] ✓✓✓ SP SETTLEMENT ACCEPTED ✓✓✓
[HO][INFO][NONE] [SETTLE]   chainId: c24c7490-03d8-4fc1-993a-573ba2157455
[HO][INFO][NONE] [SETTLE]   acceptedLastSpentIndex: 5
[HO][INFO][NONE] [SETTLE]   tokensConsumed: 5
[HO][INFO][NONE] [SETTLE]   remainingTokens: 0
[HO][INFO][NONE] [SETTLE]   timestamp: 2025-12-24T22:14:00.603749747Z
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] M3.4: Verifying SP Payment Receipt
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [M3.4-VERIFY] Verifying receipt signature...
[HO][INFO][NONE] [M3.4-VERIFY]   Canonical receipt: receiptId=ae56998e-4e95-431b-9bbb-97bb72c556c0|chainId=c24c7490-03d8-4fc1-993a-573ba2157455|reservationId=bb5dec74-2100-4d28-ac66-7a9d42964fa2|availabilityId=5e6ed5f6-a38d-406f-93a0-d87229cc32ae|y=5|newLastSpentIndex=5|timestamp=2025-12-24T22:14:00.603749747Z|hoIdentity=HomeOwner
[HO][INFO][NONE] [M3.4-VERIFY]   Signature algorithm: SHA256withRSA
[HO][INFO][NONE] [M3.4-VERIFY] ✓ SP signature verified successfully (RSA-2048, SHA256withRSA)
[HO][INFO][NONE] [M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
[HO][INFO][NONE] [M3.4-VERIFY] ✓ Payment finality established
[HO][INFO][NONE] [SETTLE] ✓ Receipt signature verified successfully
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Receipt persisted: /app/keystore/receipts/receipt_ae56998e-4e95-431b-9bbb-97bb72c556c0.json
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Immutable proof of settlement stored
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Available for offline third-party verification
[HO][INFO][NONE] [SETTLE] ✓✓✓ PAYMENT RECEIPT VERIFIED AND PERSISTED ✓✓✓
[HO][INFO][NONE] [SETTLE]   Receipt ID: ae56998e-4e95-431b-9bbb-97bb72c556c0
[HO][INFO][NONE] [SETTLE]   Payment finality established via SP signature
[HO][INFO][NONE] [SETTLE]   Receipt ready for CO forwarding
[HO][INFO][NONE] [PAY] ⚠️  TEST_DOUBLE_SPEND enabled - storing settlement for replay
[HO][INFO][NONE] [PAY] ✓ Payment receipt included in response for CO
[HO][INFO][NONE] [PAY] Payment ACCEPTED. newLastSpentIndex=4
[HO][INFO][NONE] 
Sent pay response:
[HO][INFO][NONE] {
  "startIndex": 0,
  "reservationId": "bb5dec74-2100-4d28-ac66-7a9d42964fa2",
  "chainId": "c24c7490-03d8-4fc1-993a-573ba2157455",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "bb5dec74-2100-4d28-ac66-7a9d42964fa2",
    "signatureAlg": "SHA256withRSA",
    "chainId": "c24c7490-03d8-4fc1-993a-573ba2157455",
    "availabilityId": "5e6ed5f6-a38d-406f-93a0-d87229cc32ae",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "1178DBB3DCA72FEF5EC30642BA185A8441B3F132059EFBEFF2ED978FA4B30094",
    "y": 5,
    "receiptId": "ae56998e-4e95-431b-9bbb-97bb72c556c0",
    "canonicalReceipt": "receiptId=ae56998e-4e95-431b-9bbb-97bb72c556c0|chainId=c24c7490-03d8-4fc1-993a-573ba2157455|reservationId=bb5dec74-2100-4d28-ac66-7a9d42964fa2|availabilityId=5e6ed5f6-a38d-406f-93a0-d87229cc32ae|y=5|newLastSpentIndex=5|timestamp=2025-12-24T22:14:00.603749747Z|hoIdentity=HomeOwner",
    "receiptSignature": "c2PNaxdF9UlRrxL5oP9rc49I4fDOyNbBMoIKzpc3/ATsR9g0OE4lhS2g2v/svmZq14ckYhrRwD1sV/MUK1yxtNbyVh7keSqNCqOt90P6oGv55SGlRIIjDeghfZS+Vb8bnIOBsDxn6x7ddkFlyvlHPziCXMY9bEuaHGxFgBBP5HSRAqLTV/76IVpzbkhASumIUp35qPuEUDx1XaJXQtjxzhmD/ROJ6e8uhEGxJiQ3RdhqgzQUWVC0F08PtPPuH0zpiE4xBdTSHqNFkmrVmAHTcCLOcqT4UJE0yAWf+Utf/gL9rxXyxiewfGFT9uqp+5xMOFL/2V1Pj/aQbzX7szxM/g==",
    "timestamp": "2025-12-24T22:14:00.603749747Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-24T22:14:00.637774914Z"
}
[HO][INFO][NONE] 
CarOwner disconnected

