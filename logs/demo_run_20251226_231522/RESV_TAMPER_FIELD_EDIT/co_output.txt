 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: FIELD_EDIT
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: FIELD_EDIT
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 20:17:36 UTC 2025
Valid until: Sat Dec 26 20:18:36 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 3 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 116f02d8-6c86-49ce-98de-e55901c9ae9c
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T20:17:18.318146725Z to 2025-12-27T04:17:18.318146725Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 20:14:31 UTC 2025
  Valid until: Sat Dec 26 20:15:31 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: EC948E88793A3FDE...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: EC948E88793A3FDEF568400DBAF8AC14...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 85640d7b-31cb-4e04-82d8-f5db1f924aa3
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T20:16:51.125727796Z to 2025-12-27T04:16:51.125727796Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 20:14:31 UTC 2025
  Valid until: Sat Dec 26 20:15:31 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: EC948E88793A3FDE...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: EC948E88793A3FDEF568400DBAF8AC14...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 3762c324-63c4-40ab-b7f5-57f6918f460b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T20:15:32.183385216Z to 2025-12-27T04:15:32.183385216Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 20:14:31 UTC 2025
  Valid until: Sat Dec 26 20:15:31 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: EC948E88793A3FDE...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: EC948E88793A3FDEF568400DBAF8AC14...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 116f02d8-6c86-49ce-98de-e55901c9ae9c

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: EC948E88793A3FDEF568400DBAF8AC14FFADF250B13F293137EF954733CEF355
  Received fingerprint: EC948E88793A3FDEF568400DBAF8AC14FFADF250B13F293137EF954733CEF355
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 116f02d8-6c86-49ce-98de-e55901c9ae9c
    spotId: SPOT-A1
    validFrom: 2025-12-26T20:17:18.318146725Z
    validTo: 2025-12-27T04:17:18.318146725Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success

[RESV_TAMPER] ⚠ APPLYING TAMPERING (simulating attacker) ⚠
[RESV_TAMPER] Original signedData: reservationId=8619b1aa-ab43-422a-9ee1-994becd40a10|verdict=OK|availabilityId=116f02d8-6c86-49ce-98de-e55901c9ae9c|spotId=SPOT-A1|validFrom=2025-12-26T20:17:18.318146725Z|validTo=2025-12-27T04:17:18.318146725Z|priceTokens=5|coIdentity=CarOwner
[RESV_TAMPER] Original signature (Base64): qo/QnsmfMqSqENU21zjzHGgVsDnURmXx...
[RESV_TAMPER] FIELD_EDIT: Changed 'priceTokens=5' to 'priceTokens=1'
[RESV_TAMPER] Tampered signedData: reservationId=8619b1aa-ab43-422a-9ee1-994becd40a10|verdict=OK|availabilityId=116f02d8-6c86-49ce-98de-e55901c9ae9c|spotId=SPOT-A1|validFrom=2025-12-26T20:17:18.318146725Z|validTo=2025-12-27T04:17:18.318146725Z|priceTokens=1|coIdentity=CarOwner
[RESV_TAMPER] Signature unchanged: YES
[RESV_TAMPER] Proceeding to verification with tampered data...

  Reservation ID: 8619b1aa-ab43-422a-9ee1-994becd40a10
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=8619b1aa-ab43-422a-9ee1-994becd40a10|verdict=OK|availabilityId=116f02d8-6c86-49ce-98de-e55901c9ae9c|spotId=SPOT-A1|validFrom=2025-12-26T20:17:18.318146725Z|validTo=2025-12-27T04:17:18.318146725Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=8619b1aa-ab43-422a-9ee1-994becd40a10|verdict=OK|availabilityId=116f02d8-6c86-49ce-98de-e55901c9ae9c|spotId=SPOT-A1|validFrom=2025-12-26T20:17:18.318146725Z|validTo=2025-12-27T04:17:18.318146725Z|priceTokens=1|coIdentity=CarOwner

╔═══════════════════════════════════════════════════════════════╗
║   [RESV_TAMPER] ✓ SECURITY SUCCESS                          ║
╚═══════════════════════════════════════════════════════════════╝
[RESV_TAMPER] Forged reservation detected!
[RESV_TAMPER] Failure reason: Signed data mismatch! Possible tampering or field modification.
[RESV_TAMPER] Tampering mode: FIELD_EDIT

[RESV_TAMPER] VERIFICATION COMPLETE:
  ✓ CO applied FIELD_EDIT tampering
  ✓ Signature verification correctly FAILED
  ✓ SecurityException thrown: Signed data mismatch! Possible tampering or field modification.
  ✓ CO failed closed (rejected forged reservation)
  ✓ HO identity binding enforced (cert fingerprint verified)
  ✓ No bypass mechanisms available

[RESV_TAMPER] CONCLUSION:
  SECURITY SUCCESS: Forged reservation detected
  (signature/canonical data mismatch)
  The system is SECURE against reservation tampering.

