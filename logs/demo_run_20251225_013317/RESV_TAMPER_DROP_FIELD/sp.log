[SP][INFO][NONE] Waiting for CAuth to start...
[SP][INFO][NONE] 
=== Service Provider Starting ===
[SP][INFO][NONE] Initializing cryptographic baseline...

[SP][INFO][NONE] Found existing certificate, loading from keystore...
[SP][INFO][NONE] ...
[SP][INFO][NONE] ✓ Certificate chain loaded (3 certificates)
[SP][INFO][NONE] ...
[SP][INFO][NONE]   Validating certificate chain (3 certificates):
[SP][INFO][NONE]     [0] C=BE,O=Parking System,CN=ServiceProvider
[SP][INFO][NONE]         Issuer: CN=172.20.0.10,O=Private Parking,C=BE
[SP][INFO][NONE]         ...
[SP][INFO][NONE]     [1] CN=172.20.0.10,O=Private Parking,C=BE
[SP][INFO][NONE]         Issuer: CN=Root CA,O=National Authority,C=Country Code
[SP][INFO][NONE]         ...
[SP][INFO][NONE]     [2] CN=Root CA,O=National Authority,C=Country Code
[SP][INFO][NONE]         Issuer: CN=Root CA,O=National Authority,C=Country Code
[SP][INFO][NONE]   ✓ Chain terminates at trusted Root CA: root_ca
[SP][INFO][NONE]   ...
[SP][INFO][NONE] 
╔═══════════════════════════════════════════╗
[SP][INFO][NONE] ║   CRYPTOGRAPHIC IDENTITY ESTABLISHED     ║
[SP][INFO][NONE] ╚═══════════════════════════════════════════╝
[SP][INFO][NONE] Subject: C=BE,O=Parking System,CN=ServiceProvider
[SP][INFO][NONE] Issuer: CN=172.20.0.10,O=Private Parking,C=BE
[SP][INFO][NONE] Valid from: Wed Dec 24 22:22:40 UTC 2025
[SP][INFO][NONE] Valid until: Thu Dec 24 22:23:40 UTC 2026
[SP][INFO][NONE] Serial: 929A808AD0EFCF0ACB484BC62D80E082
[SP][INFO][NONE] ✓ Certificate and private key verified

[SP][INFO][NONE] === Starting SP Server ===
[SP][INFO][NONE] 
=== SP CRYPTOGRAPHIC BASELINE ESTABLISHED ===
[SP][INFO][NONE] Version: 2025-12-22 (Hardened TLS with mTLS enforcement)
[SP][INFO][NONE] ✓ Enabled TLS protocols: [TLSv1.3, TLSv1.2]
[SP][INFO][NONE] ✓ Strong cipher suites configured: 9 suites
[SP][INFO][NONE]  Mutual TLS (mTLS) REQUIRED - client certificates enforced
[SP][INFO][NONE] 
=== TLS Server Configuration ===
[SP][INFO][NONE] Server listening on port: 8444
[SP][INFO][NONE] Server certificate subject: C=BE,O=Parking System,CN=ServiceProvider
[SP][INFO][NONE] Server certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[SP][INFO][NONE] Certificate serial: 929A808AD0EFCF0ACB484BC62D80E082
[SP][INFO][NONE] Certificate algorithm: SHA256withRSA
[SP][INFO][NONE] Public key algorithm: RSA
[SP][INFO][NONE] RSA key size: 2048 bits
[SP][INFO][NONE] mTLS enforcement: ENABLED (client certificates REQUIRED)
[SP][INFO][NONE] 
...
[SP][INFO][NONE] SP server ready | Port=8444
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] 
=== Publishing Parking Availability from HomeOwner ===
[SP][INFO][NONE]   Home Owner: HO-001
[SP][INFO][NONE]   Spot ID: SPOT-A1
[SP][INFO][NONE]   Valid: 2025-12-24T22:33:15.876009381Z to 2025-12-25T06:33:15.876009381Z
[SP][INFO][NONE]   Price: 5 tokens
[SP][INFO][NONE]   Location: Downtown-North
[SP][INFO][NONE] ✓ Availability stored with ID: 631f02f1-c3de-45e1-8356-4024642d5e2f
[SP][INFO][NONE] ✓ Total availabilities in system: 1
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Availability Discovery Request from CarOwner ===
[SP][INFO][NONE]   Total availabilities in system: 1
[SP][INFO][NONE]   [631f02f1-c3de-45e1-8356-4024642d5e2f] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE] ✓ Returned 1 availability record(s) to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] 
=== Publishing Parking Availability from HomeOwner ===
[SP][INFO][NONE]   Home Owner: HO-001
[SP][INFO][NONE]   Spot ID: SPOT-A1
[SP][INFO][NONE]   Valid: 2025-12-24T22:33:28.828315429Z to 2025-12-25T06:33:28.828315429Z
[SP][INFO][NONE]   Price: 5 tokens
[SP][INFO][NONE]   Location: Downtown-North
[SP][INFO][NONE] ✓ Availability stored with ID: 191001f5-0052-4ce1-ad30-d01579fb3c63
[SP][INFO][NONE] ✓ Total availabilities in system: 2
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Availability Discovery Request from CarOwner ===
[SP][INFO][NONE]   Total availabilities in system: 2
[SP][INFO][NONE]   [191001f5-0052-4ce1-ad30-d01579fb3c63] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [631f02f1-c3de-45e1-8356-4024642d5e2f] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE] ✓ Returned 2 availability record(s) to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Generating 5 payment tokens for CarOwner ===
[SP][INFO][NONE] ✓ Generated secret s (32 bytes)
[SP][INFO][NONE] ✓ Generated hash chain of length 5
[SP][INFO][NONE]   Root H^5(s): 7116DAA1DE53C7A9...
[SP][INFO][NONE] ✓ Signed root with SP private key (256 bytes)
[SP][INFO][NONE] ✓ Stored chain metadata (ID: 6bc5619a-0d52-45fc-80f6-fe4153235fd0)
[SP][INFO][NONE] ✓ Token batch ready to send to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][INFO][NONE] [SETTLE] Settlement Request Received from HomeOwner
[SP][INFO][NONE] [SETTLE]   chainId: 6bc5619a-0d52-45fc-80f6-fe4153235fd0
[SP][INFO][NONE] [SETTLE]   reservationId: ece90d1d-9b7a-4259-b1f5-97f1571e42dc
[SP][INFO][NONE] [SETTLE]   availabilityId: 191001f5-0052-4ce1-ad30-d01579fb3c63
[SP][INFO][NONE] [SETTLE]   y (tokens spent): 5
[SP][INFO][NONE] [SETTLE]   newLastSpentIndex: 5
[SP][INFO][NONE] [SETTLE]   x (chain length): 5
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][INFO][NONE] [SETTLE] ✓ Cryptographic proof verified: token hashes to root
[SP][INFO][NONE] [SETTLE]   (hashed 0 times from last spent token to reach root)
[SP][INFO][NONE] [SETTLE] ✓✓✓ SETTLEMENT ACCEPTED ✓✓✓
[SP][INFO][NONE] [SETTLE]   chainId: 6bc5619a-0d52-45fc-80f6-fe4153235fd0
[SP][INFO][NONE] [SETTLE]   reservationId: ece90d1d-9b7a-4259-b1f5-97f1571e42dc
[SP][INFO][NONE] [SETTLE]   Previous lastSpentIndex: 0
[SP][INFO][NONE] [SETTLE]   Updated lastSpentIndex: 5
[SP][INFO][NONE] [SETTLE]   Tokens consumed: 5
[SP][INFO][NONE] [SETTLE]   Remaining tokens: 0
[SP][INFO][NONE] [AUDIT] SETTLEMENT_ACCEPTED{chainId=6bc5619a-0d52-45fc-80f6-fe4153235fd0, oldIndex=0, newIndex=5, tokensSpent=5, reservationId=ece90d1d-9b7a-4259-b1f5-97f1571e42dc}
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][INFO][NONE] [SETTLE] M3.4: Generating Cryptographically Verifiable Receipt
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][INFO][NONE] [SETTLE] Canonical Receipt Data:
[SP][INFO][NONE] [SETTLE]   receiptId=fe34213f-a253-4eef-b0ff-e48465aaca5f|chainId=6bc5619a-0d52-45fc-80f6-fe4153235fd0|reservationId=ece90d1d-9b7a-4259-b1f5-97f1571e42dc|availabilityId=191001f5-0052-4ce1-ad30-d01579fb3c63|y=5|newLastSpentIndex=5|timestamp=2025-12-24T22:33:36.714413433Z|hoIdentity=HomeOwner
[SP][INFO][NONE] [SETTLE] ✓ Receipt signed with SP private key (RSA-2048)
[SP][INFO][NONE] [SETTLE]   Algorithm: SHA256withRSA
[SP][INFO][NONE] [SETTLE]   Signature length: 256 bytes
[SP][INFO][NONE] [SETTLE] ✓ SP certificate fingerprint: EFE01135BDB60FC06BEF53E7A8B58CC7...
[SP][INFO][NONE] [SETTLE] ✓✓✓ PAYMENT RECEIPT GENERATED ✓✓✓
[SP][INFO][NONE] [SETTLE]   Receipt ID: fe34213f-a253-4eef-b0ff-e48465aaca5f
[SP][INFO][NONE] [SETTLE]   Non-repudiation: SP signature binds finality to payment
[SP][INFO][NONE] [SETTLE]   Auditability: Receipt enables offline third-party verification
[SP][INFO][NONE] [AUDIT] RECEIPT_GENERATED{receiptId=fe34213f-a253-4eef-b0ff-e48465aaca5f, chainId=6bc5619a-0d52-45fc-80f6-fe4153235fd0, reservationId=ece90d1d-9b7a-4259-b1f5-97f1571e42dc}
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][INFO][NONE] [SETTLE] Settlement Request Received from HomeOwner
[SP][INFO][NONE] [SETTLE]   chainId: 6bc5619a-0d52-45fc-80f6-fe4153235fd0
[SP][INFO][NONE] [SETTLE]   reservationId: ece90d1d-9b7a-4259-b1f5-97f1571e42dc
[SP][INFO][NONE] [SETTLE]   availabilityId: 191001f5-0052-4ce1-ad30-d01579fb3c63
[SP][INFO][NONE] [SETTLE]   y (tokens spent): 5
[SP][ERR][NONE] [SETTLE] ❌❌❌ DOUBLE_SPEND_DETECTED ❌❌❌
[SP][ERR][NONE] [SETTLE]   chainId: 6bc5619a-0d52-45fc-80f6-fe4153235fd0
[SP][ERR][NONE] [SETTLE]   currentLastSpentIndex: 5
[SP][ERR][NONE] [SETTLE]   attemptedNewIndex: 5
[SP][ERR][NONE] [SETTLE]   reservationId: ece90d1d-9b7a-4259-b1f5-97f1571e42dc
[SP][INFO][NONE] [SETTLE]   newLastSpentIndex: 5
[SP][INFO][NONE] [SETTLE]   x (chain length): 5
[SP][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[SP][ERR][NONE] [AUDIT] DOUBLE_SPEND_DETECTED{chainId=6bc5619a-0d52-45fc-80f6-fe4153235fd0, oldIndex=5, newIndex=5, reservationId=ece90d1d-9b7a-4259-b1f5-97f1571e42dc}
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] 
=== Publishing Parking Availability from HomeOwner ===
[SP][INFO][NONE]   Home Owner: HO-001
[SP][INFO][NONE]   Spot ID: SPOT-A1
[SP][INFO][NONE]   Valid: 2025-12-24T22:33:47.917031188Z to 2025-12-25T06:33:47.917031188Z
[SP][INFO][NONE]   Price: 5 tokens
[SP][INFO][NONE]   Location: Downtown-North
[SP][INFO][NONE] ✓ Availability stored with ID: 7bfbd12d-35c2-46ed-9c1e-982ae992c08e
[SP][INFO][NONE] ✓ Total availabilities in system: 3
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Availability Discovery Request from CarOwner ===
[SP][INFO][NONE]   Total availabilities in system: 3
[SP][INFO][NONE]   [191001f5-0052-4ce1-ad30-d01579fb3c63] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [7bfbd12d-35c2-46ed-9c1e-982ae992c08e] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [631f02f1-c3de-45e1-8356-4024642d5e2f] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE] ✓ Returned 3 availability record(s) to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Generating 5 payment tokens for CarOwner ===
[SP][INFO][NONE] ✓ Generated secret s (32 bytes)
[SP][INFO][NONE] ✓ Generated hash chain of length 5
[SP][INFO][NONE]   Root H^5(s): 2088688FBE190030...
[SP][INFO][NONE] ✓ Signed root with SP private key (256 bytes)
[SP][INFO][NONE] ✓ Stored chain metadata (ID: 1b74cc83-d623-4586-ae87-2bcc8bdaca56)
[SP][INFO][NONE] ✓ Token batch ready to send to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=HomeOwner | Fingerprint=8349A96A416D8E51...
[SP][INFO][NONE] 
=== Publishing Parking Availability from HomeOwner ===
[SP][INFO][NONE]   Home Owner: HO-001
[SP][INFO][NONE]   Spot ID: SPOT-A1
[SP][INFO][NONE]   Valid: 2025-12-24T22:34:06.518863155Z to 2025-12-25T06:34:06.518863155Z
[SP][INFO][NONE]   Price: 5 tokens
[SP][INFO][NONE]   Location: Downtown-North
[SP][INFO][NONE] ✓ Availability stored with ID: 7b5bd83b-8265-4a98-a3ec-443517355fa2
[SP][INFO][NONE] ✓ Total availabilities in system: 4
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
HomeOwner disconnected
[SP][AUDIT][NONE] Client authenticated | CN=CarOwner | Fingerprint=42CCA2CA927C4B2F...
[SP][INFO][NONE] 
=== Availability Discovery Request from CarOwner ===
[SP][INFO][NONE]   Total availabilities in system: 4
[SP][INFO][NONE]   [191001f5-0052-4ce1-ad30-d01579fb3c63] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [7bfbd12d-35c2-46ed-9c1e-982ae992c08e] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [7b5bd83b-8265-4a98-a3ec-443517355fa2] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE]   [631f02f1-c3de-45e1-8356-4024642d5e2f] SPOT-A1 - 5 tokens (HO: HomeOwner)
[SP][INFO][NONE] ✓ Returned 4 availability record(s) to CarOwner
[SP][INFO][NONE] ══════════════════════════════════════════════════
[SP][INFO][NONE] 
CarOwner disconnected
[SP][SEC_ERR][NONE] TLS handshake failed | Exception: SSLHandshakeException: Empty client certificate chain
[SP][INFO][NONE] 
Client disconnected
[SP][SEC_OK][NONE] Rejected rogue client certificate (PKIX path validation failed)
[SP][INFO][NONE] 
Client disconnected
[SP][SEC_ERR][NONE] TLS handshake failed | Exception: SSLHandshakeException: Empty client certificate chain
[SP][INFO][NONE] 
Client disconnected
[SP][INFO][NONE] 
Client disconnected
[SP][SEC_ERR][NONE] TLS handshake failed | Exception: SSLHandshakeException: Empty client certificate chain
[SP][INFO][NONE] 
Client disconnected
[SP][SEC_ERR][NONE] TLS handshake failed | Exception: SSLHandshakeException: Empty client certificate chain
[SP][SEC_ERR][NONE] TLS handshake failed | Exception: SSLHandshakeException: Empty client certificate chain
[SP][INFO][NONE] 
Client disconnected
