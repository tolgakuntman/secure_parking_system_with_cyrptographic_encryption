 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 20:16:05 UTC 2025
Valid until: Sat Dec 26 20:17:05 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 2 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 85640d7b-31cb-4e04-82d8-f5db1f924aa3
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T20:16:51.125727796Z to 2025-12-27T04:16:51.125727796Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 20:14:31 UTC 2025
  Valid until: Sat Dec 26 20:15:31 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: EC948E88793A3FDE...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: EC948E88793A3FDEF568400DBAF8AC14...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 3762c324-63c4-40ab-b7f5-57f6918f460b
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T20:15:32.183385216Z to 2025-12-27T04:15:32.183385216Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 20:14:31 UTC 2025
  Valid until: Sat Dec 26 20:15:31 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: EC948E88793A3FDE...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: EC948E88793A3FDEF568400DBAF8AC14...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 85640d7b-31cb-4e04-82d8-f5db1f924aa3

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: EC948E88793A3FDEF568400DBAF8AC14FFADF250B13F293137EF954733CEF355
  Received fingerprint: EC948E88793A3FDEF568400DBAF8AC14FFADF250B13F293137EF954733CEF355
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 85640d7b-31cb-4e04-82d8-f5db1f924aa3
    spotId: SPOT-A1
    validFrom: 2025-12-26T20:16:51.125727796Z
    validTo: 2025-12-27T04:16:51.125727796Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: bd310230-2222-41b7-9f66-c5c8444e1e1f
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=bd310230-2222-41b7-9f66-c5c8444e1e1f|verdict=OK|availabilityId=85640d7b-31cb-4e04-82d8-f5db1f924aa3|spotId=SPOT-A1|validFrom=2025-12-26T20:16:51.125727796Z|validTo=2025-12-27T04:16:51.125727796Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=bd310230-2222-41b7-9f66-c5c8444e1e1f|verdict=OK|availabilityId=85640d7b-31cb-4e04-82d8-f5db1f924aa3|spotId=SPOT-A1|validFrom=2025-12-26T20:16:51.125727796Z|validTo=2025-12-27T04:16:51.125727796Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/bd310230-2222-41b7-9f66-c5c8444e1e1f.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "292b4b2f-728a-454f-bda4-9a4b66ca88e6",
  "rootSignature": "jS5VTzRur3GREbU3PN3tD7cjZqREmaJ/gTLvo6bQ+DWlNwlrknkgrLAXbCJikORMiY69ts2y/Wvp3P9e1xPE/hjvXXG/Nbo2MVQesbSdM6H/9UX440m0rLpVre7s04ebmZLOFWDQVNbQjvgBa/mBL+Enqx+zytmzAwx1My+M21d9GkplQst1bznJMTiViVoRMNYeJlE42HDqSASO9rzS82bb696mTTY8S5zf7vC1GTRP7hzODfoPyGKDbmwMChxXdinLjYXqW84VuaaaHGhga/HRoSYluAZ+eAXO0ZvVLoZVQrwuVhg3VjSnoRTU0yiRVqC+RU3LdKmHysHYRL8LBQ==",
  "root": "3iMzRRR6eGrpN9glHhOB0+p6KPhBTS4va3DjdmICojw=",
  "x": 5,
  "tokens": [
    "o2NOzUAJSDYQf02VeJj1eljc3kAuo7bnPCa0TeIODPY=",
    "iZM9d9njZYJ1Kk0+09Wal+5AKsy7zNqTZ48OYjBhbGA=",
    "VCn0PdB1bhMGEWUSWleuGLDcuPCLMS4AAdJ3C2kKq8E=",
    "sAGoJM95/EiQoCazupvK3610nOgs+BVmF5sYDptHd1c=",
    "3iMzRRR6eGrpN9glHhOB0+p6KPhBTS4va3DjdmICojw="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 292b4b2f-728a-454f-bda4-9a4b66ca88e6
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: DE233345147A786AE937D8251E1381D3EA7A28F8414D2E2F6B70E3766202A23C
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: A3634ECD40094836...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 292b4b2f-728a-454f-bda4-9a4b66ca88e6
  Using SP-issued token batch, chainId=292b4b2f-728a-454f-bda4-9a4b66ca88e6
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "startIndex": 0,
  "reservationId": "bd310230-2222-41b7-9f66-c5c8444e1e1f",
  "chainId": "292b4b2f-728a-454f-bda4-9a4b66ca88e6",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "bd310230-2222-41b7-9f66-c5c8444e1e1f",
    "signatureAlg": "SHA256withRSA",
    "chainId": "292b4b2f-728a-454f-bda4-9a4b66ca88e6",
    "availabilityId": "85640d7b-31cb-4e04-82d8-f5db1f924aa3",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "F0E99C5757EFBBB1C552F117757522DBE8260F87331AEF7EFBC22153B1D37377",
    "y": 5,
    "receiptId": "d0c5d59e-9f4b-459f-b67a-9aca673888e2",
    "canonicalReceipt": "receiptId=d0c5d59e-9f4b-459f-b67a-9aca673888e2|chainId=292b4b2f-728a-454f-bda4-9a4b66ca88e6|reservationId=bd310230-2222-41b7-9f66-c5c8444e1e1f|availabilityId=85640d7b-31cb-4e04-82d8-f5db1f924aa3|y=5|newLastSpentIndex=5|timestamp=2025-12-26T20:17:06.187906803Z|hoIdentity=HomeOwner",
    "receiptSignature": "i2WfsrF+SiCS3n7jGdYtw/ekOYRy+MDzEqRSQSwtRH6B8vFz1yyvKNNYsI6d0l0M82yARhrQgasTqnwxTYCSpr3/kJDu/xK0btpF/YAVsjqOafIPjMJgCfENG2jjstcm2aJpKCCRgbjzjdxnKtty+uLKj6od0LILOWJBZqgEGNzRFb/FTssy2opk9qsvhVxwlOpaAwD/2OQ1pjOQ1QQl+m7/NTjmEDQOUwAe9GpBvp8h856oi+yOy5X2jPn40oIbketpjFuvao30U8RPzgPOCF9YnB3xcsGM9h9FsHUnVgLOjSlqrdpf7oTom/j1/Vi4fUqsJzhKlt2RXhkXrs+5CA==",
    "timestamp": "2025-12-26T20:17:06.187906803Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-26T20:17:06.237134261Z"
}

[M4.2] Waiting 500 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
✗ HO rejected payment: Settlement with SP failed - payment not accepted
   Verdict: OK
   Non-repudiable proof stored: bd310230-2222-41b7-9f66-c5c8444e1e1f
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
