ho-container  | [SETTLE] ✓✓✓ SP SETTLEMENT ACCEPTED ✓✓✓
ho-container  | [SETTLE]   chainId: 71c6a792-9607-4d5d-a726-0c0a08a3a059
ho-container  | [SETTLE]   acceptedLastSpentIndex: 5
ho-container  | [SETTLE]   tokensConsumed: 5
ho-container  | [SETTLE]   remainingTokens: 0
ho-container  | [SETTLE]   timestamp: 2025-12-26T10:13:20.030522586Z
ho-container  | [SETTLE] ═══════════════════════════════════════════════════
ho-container  | [SETTLE] M3.4: Verifying SP Payment Receipt
ho-container  | [SETTLE] ═══════════════════════════════════════════════════
ho-container  | [M3.4-VERIFY] Verifying receipt signature...
ho-container  | [M3.4-VERIFY]   Canonical receipt: receiptId=3f3709e0-a0af-4698-83d4-3fb3386b21e1|chainId=71c6a792-9607-4d5d-a726-0c0a08a3a059|reservationId=61ce8026-f34f-48df-92ac-b922a98a4d0e|availabilityId=65cb0872-654f-4702-947d-d902d6d0e59d|y=5|newLastSpentIndex=5|timestamp=2025-12-26T10:13:20.030522586Z|hoIdentity=HomeOwner
ho-container  | [M3.4-VERIFY]   Signature algorithm: SHA256withRSA
ho-container  | [M3.4-VERIFY] ✓ SP signature verified successfully (RSA-2048, SHA256withRSA)
ho-container  | [M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
ho-container  | [M3.4-VERIFY] ✓ Payment finality established
ho-container  | [SETTLE] ✓ Receipt signature verified successfully
ho-container  | [M3.4-PERSIST] ✓ Receipt persisted: /app/keystore/receipts/receipt_3f3709e0-a0af-4698-83d4-3fb3386b21e1.json
ho-container  | [M3.4-PERSIST] ✓ Immutable proof of settlement stored
ho-container  | [M3.4-PERSIST] ✓ Available for offline third-party verification
ho-container  | [SETTLE] ✓✓✓ PAYMENT RECEIPT VERIFIED AND PERSISTED ✓✓✓
ho-container  | [SETTLE]   Receipt ID: 3f3709e0-a0af-4698-83d4-3fb3386b21e1
ho-container  | [SETTLE]   Payment finality established via SP signature
ho-container  | [SETTLE]   Receipt ready for CO forwarding
ho-container  | [PAY] ⚠️  TEST_DOUBLE_SPEND enabled - storing settlement for replay
ho-container  | [PAY] ✓ Payment receipt included in response for CO
ho-container  | [PAY] Payment ACCEPTED. newLastSpentIndex=4
ho-container  | 
ho-container  | Sent pay response:
ho-container  | {
ho-container  |   "startIndex": 0,
ho-container  |   "reservationId": "61ce8026-f34f-48df-92ac-b922a98a4d0e",
ho-container  |   "chainId": "71c6a792-9607-4d5d-a726-0c0a08a3a059",
ho-container  |   "spentCount": 5,
ho-container  |   "newLastSpentIndex": 4,
ho-container  |   "paymentReceipt": {
ho-container  |     "hoIdentity": "HomeOwner",
ho-container  |     "reservationId": "61ce8026-f34f-48df-92ac-b922a98a4d0e",
ho-container  |     "signatureAlg": "SHA256withRSA",
ho-container  |     "chainId": "71c6a792-9607-4d5d-a726-0c0a08a3a059",
ho-container  |     "availabilityId": "65cb0872-654f-4702-947d-d902d6d0e59d",
ho-container  |     "newLastSpentIndex": 5,
ho-container  |     "spCertFingerprint": "2CD1D4B77C5262DB298833E252A95C51E5D2F2D47A6CAB3A6116A447CF18E37B",
ho-container  |     "y": 5,
ho-container  |     "receiptId": "3f3709e0-a0af-4698-83d4-3fb3386b21e1",
ho-container  |     "canonicalReceipt": "receiptId=3f3709e0-a0af-4698-83d4-3fb3386b21e1|chainId=71c6a792-9607-4d5d-a726-0c0a08a3a059|reservationId=61ce8026-f34f-48df-92ac-b922a98a4d0e|availabilityId=65cb0872-654f-4702-947d-d902d6d0e59d|y=5|newLastSpentIndex=5|timestamp=2025-12-26T10:13:20.030522586Z|hoIdentity=HomeOwner",
ho-container  |     "receiptSignature": "dkRux81Ux0vild8WOotzTh125LKrqLup39wJ0TAOUmfJd0D+KeUMrcS480zm6TIdnN6ncqU2PveXyJ6h0XNCSSxgTyj0oNqSWVZDIT5F1P884muVKKw7LMoADEtcEmnio2sjnU5z55rC/g3/axCnum57tAEPKwdsfwWf1yUxbN/Uc+xPokiVQTDDbWm6IaqCRIHTqSOm5rhOWO2HHx0nFwKUYDOSWzVJC1N4tgI9yk1b9pLeqrZKgePqIvLz7VVW0P6055w1eqi5U70x+goEtZjojbLfGWXw3VMIZCOZpdNoXtrjNfUppbUchwix0ccvgt5JSgvZPlL0OdiJZBnr1w==",
ho-container  |     "timestamp": "2025-12-26T10:13:20.030522586Z"
ho-container  |   },
ho-container  |   "message": "payment accepted",
ho-container  |   "status": "success",
ho-container  |   "timestamp": "2025-12-26T10:13:20.068020170Z"
ho-container  | }
ho-container  | 
ho-container  | CarOwner disconnected
ho-container  | 
ho-container  | 
ho-container  | [PAY] ═══════════════════════════════════════════════════
ho-container  | [PAY] ⚠️  NEGATIVE TEST: Attempting Double-Spend Replay
ho-container  | [PAY] ═══════════════════════════════════════════════════
ho-container  | [SETTLE] ═══════════════════════════════════════════════════
ho-container  | [SETTLE] Preparing Settlement Request to SP
ho-container  | [SETTLE]   chainId: 71c6a792-9607-4d5d-a726-0c0a08a3a059
ho-container  | [SETTLE]   reservationId: 61ce8026-f34f-48df-92ac-b922a98a4d0e
ho-container  | [SETTLE]   y (tokens spent): 5
ho-container  | [SETTLE]   newLastSpentIndex: 5
ho-container  | [SETTLE]   x (chain length): 5
ho-container  | [SETTLE] ═══════════════════════════════════════════════════
ho-container  | [SETTLE] ✓ TLS hardening applied (TLS 1.3/1.2, AEAD ciphers only)
ho-container  | [SETTLE] Initiating explicit TLS handshake...
ho-container  | [SETTLE] ✓ TLS handshake completed successfully
ho-container  | [SETTLE]   Protocol: TLSv1.3
ho-container  | [SETTLE]   Cipher Suite: TLS_AES_256_GCM_SHA384
ho-container  | [SETTLE] ✓ SP certificate verified: C=BE,O=Parking System,CN=ServiceProvider
ho-container  | [SETTLE] → Settlement request sent to SP
ho-container  | [SETTLE] ❌❌❌ SP SETTLEMENT REJECTED ❌❌❌
ho-container  | [SETTLE]   Reason: double_spend
ho-container  | [SETTLE]   Message: DOUBLE_SPEND_DETECTED: attempting to reuse already-spent tokens
ho-container  | [SETTLE] ⚠️  DOUBLE_SPEND_DETECTED by SP
ho-container  | [SETTLE]   currentLastSpentIndex: 5
ho-container  | [SETTLE]   rejectedNewIndex: 5
ho-container  | [PAY] ✓✓✓ SECURITY SUCCESS: SP REJECTED DOUBLE-SPEND ✓✓✓
ho-container  | [PAY] Double-spend protection working correctly!
ho-container  | [PAY] ═══════════════════════════════════════════════════
ho-container  | 
ho-container  | 
ho-container  | === Inbound Reservation Request ===
ho-container  | 
ho-container  | ║   CO AUTHENTICATED VIA mTLS               ║
ho-container  | CO CN: CarOwner
ho-container  | CO address: /172.20.0.13:53248
ho-container  | CO certificate subject: C=BE,O=Parking System,CN=CarOwner
ho-container  | CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
ho-container  | CO certificate serial: E4DB9AF26D5A82F6014787DB530F67F9
ho-container  | 
ho-container  | TLS Session Details:
ho-container  |   Protocol: TLSv1.3
ho-container  |   Cipher suite: TLS_AES_256_GCM_SHA384
ho-container  | ═══════════════════════════════════════════
ho-container  | 
ho-container  | Received request from CarOwner:
ho-container  | {
ho-container  |   "priceTokens": 5,
ho-container  |   "method": "requestReservation",
ho-container  |   "availabilityId": "65cb0872-654f-4702-947d-d902d6d0e59d",
ho-container  |   "spotId": "SPOT-A1",
ho-container  |   "validFrom": "2025-12-26T10:13:15.281856542Z",
ho-container  |   "validTo": "2025-12-26T18:13:15.281856542Z",
ho-container  |   "coIdentity": "CarOwner"
ho-container  | }
ho-container  | 
ho-container  | === Processing Reservation Request (Milestone 2.4) ===
ho-container  |   Availability ID: 65cb0872-654f-4702-947d-d902d6d0e59d
ho-container  |   Spot ID: SPOT-A1
ho-container  |   Valid: 2025-12-26T10:13:15.281856542Z to 2025-12-26T18:13:15.281856542Z
ho-container  |   Price: 5 tokens
ho-container  |   Requested CO Identity: CarOwner
ho-container  | ✓ CO identity verified: CarOwner
ho-container  | ✓ Availability ID matches published availability
ho-container  | Generated Reservation ID: 4bcc6400-9cf3-45cc-9df0-2b491ab31eac
ho-container  | 
ho-container  | ─ Generating Cryptographic Signature ─
ho-container  | Canonical data to sign:
ho-container  |   reservationId=4bcc6400-9cf3-45cc-9df0-2b491ab31eac|verdict=OK|availabilityId=65cb0872-654f-4702-947d-d902d6d0e59d|spotId=SPOT-A1|validFrom=2025-12-26T10:13:15.281856542Z|validTo=2025-12-26T18:13:15.281856542Z|priceTokens=5|coIdentity=CarOwner
ho-container  | ✓ Signature generated with HO private key
ho-container  |   Algorithm: SHA256withRSA
ho-container  |   Signature length: 256 bytes
ho-container  |   Signature (Base64): dCnVmQmTMn7StjL2snGKkxROY4V0TLKh...
ho-container  | 
ho-container  | ╔═══════════════════════════════════════════════════════════╗
ho-container  | ║   RESERVATION DECISION: OK
ho-container  | ╚═══════════════════════════════════════════════════════════╝
ho-container  | Reservation ID: 4bcc6400-9cf3-45cc-9df0-2b491ab31eac
ho-container  | CO Identity: CarOwner
ho-container  | ✓ Cryptographic signature binds HO to this decision
ho-container  | ✓ Non-repudiable authorization established
ho-container  | 
ho-container  | Sent signed reservation response:
ho-container  | {
ho-container  |   "hoIdentity": "HomeOwner",
ho-container  |   "reservationId": "4bcc6400-9cf3-45cc-9df0-2b491ab31eac",
ho-container  |   "signatureAlg": "SHA256withRSA",
ho-container  |   "signature": "dCnVmQmTMn7StjL2snGKkxROY4V0TLKhsh5vSOd4lNVLmkI4Mxur1IJg5KSAGuaYL7f/VOmjPr6wgpBJi9gghltlgtkzyy1NQsh5YbQ70+I22lAaFq0tVvQjxFjlJdFiQJ1wXZSoHB+4yh7WQbMhSvWmWJEemEKqMHWShebzVp0GsrdEZfWXerFOHRAaICzkNXvQHnxXLmh89Y3W650doL1myjRXDsKDNT3iZagpVfrf3emt8y/4eDkPgewJhJqfnANX4ZGcqM0OPboHk/kojcbev3+oQbYqNL+RCrM4BIvF0J7LFvqle6dxGJ7gl1X7TRq8sXh+l85QBwxrurubyQ==",
ho-container  |   "signedData": "reservationId=4bcc6400-9cf3-45cc-9df0-2b491ab31eac|verdict=OK|availabilityId=65cb0872-654f-4702-947d-d902d6d0e59d|spotId=SPOT-A1|validFrom=2025-12-26T10:13:15.281856542Z|validTo=2025-12-26T18:13:15.281856542Z|priceTokens=5|coIdentity=CarOwner",
ho-container  |   "verdict": "OK",
ho-container  |   "status": "success"
ho-container  | }
ho-container  | 
ho-container  | CarOwner disconnected
ho-container  | 
ho-container  | 
ho-container  | === Inbound Reservation Request ===
ho-container  | 
ho-container  | ║   CO AUTHENTICATED VIA mTLS               ║
ho-container  | CO CN: CarOwner
ho-container  | CO address: /172.20.0.13:53260
ho-container  | CO certificate subject: C=BE,O=Parking System,CN=CarOwner
ho-container  | CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
ho-container  | CO certificate serial: E4DB9AF26D5A82F6014787DB530F67F9
ho-container  | 
ho-container  | TLS Session Details:
ho-container  |   Protocol: TLSv1.3
ho-container  |   Cipher suite: TLS_AES_256_GCM_SHA384
ho-container  | ═══════════════════════════════════════════
ho-container  | 
ho-container  | Received request from CarOwner:
ho-container  | {
ho-container  |   "startIndex": 0,
ho-container  |   "method": "pay",
ho-container  |   "reservationId": "4bcc6400-9cf3-45cc-9df0-2b491ab31eac",
ho-container  |   "chainId": "ca029345-de32-4062-9800-27637851cdf7",
ho-container  |   "rootSignature": "ScY/8dMUYUtPjbJMBGImr8HGTz7uGN7RN+sHvMtVVZ9bIGuSWpcLM8VhWsLGqFx1z5qlieTHimnT5W+nKhh/fllv7HVdCCuQW1To/X8eAbqVdDsaiDxWGUYQMesgS9ChwaAL+YSkdIh255ZR/AuPgSu/1wQ2ZAyIxlwdaK2YK7AQJl5sAFCxEB0q20z200JCfyTRAdn6FWKCPsneBOCgoknQHq4uEgwLGb5WRz9V9R7fK1kPhTpTJJPwBjgeTUvE80FcHlQTHQYaW8NuRSk5mdTRQ7eXntu9OvE044gX+YfWRuHPQ0aSG7Vf0ESkYhazvD5F6OwSuSHH/BubsESukA==",
ho-container  |   "root": "JUX2rIBMRHDRyOOWje+ouKETtTKnVeXbJxegcWNvEOk=",
ho-container  |   "x": 5,
ho-container  |   "tokensToSpend": [
ho-container  |     "9UMkPmBzBE5HevT9QjQLw1hg+MrZHp6HYQk+dYnOMrE=",
ho-container  |     "ROxYBRBr+a1iYpVbXx9ZcTDopKw+JoY9pKfelHxhQko=",
ho-container  |     "LPlISRkvadH+V4XTaTTg/vxrN8i/tywOTpXTS5hDkmQ=",
ho-container  |     "7F1ubuZEAXr+hgsSyZ6aZHkifafFCsbQ4JjFmj38HMo=",
ho-container  |     "JUX2rIBMRHDRyOOWje+ouKETtTKnVeXbJxegcWNvEOk="
ho-container  |   ]
ho-container  | }
ho-container  | [M3.2] root signature verified via cached SP public key
ho-container  | [M3.2] policy checks passed (reservation verdict OK, token count matches)
ho-container  | 
ho-container  | Sent pay response:
ho-container  | {
ho-container  |   "reason": "security_violation",
ho-container  |   "code": "token_tampering_detected",
ho-container  |   "message": "adjacency check failed at i=0 - possible token tampering",
ho-container  |   "status": "error"
ho-container  | }
ho-container  | [M4] REJECTED: adjacency check failed at i=0 (possible token tampering)
ho-container  | 
ho-container  | CarOwner disconnected
ho-container  | 
