[HO][INFO][NONE] Waiting for CAuth and SP to start...
[HO][INFO][NONE] 
=== Home Owner (HO) Starting ===
[HO][INFO][NONE] Found existing certificate, loading from keystore...
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
╔═══════════════════════════════════════════╗
[HO][INFO][NONE] ║   HO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════╝
[HO][INFO][NONE] Subject: CN=HomeOwner,O=Parking System,C=BE
[HO][INFO][NONE] Issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] Valid from: Wed Dec 24 22:12:45 UTC 2025
[HO][INFO][NONE] Valid until: Thu Dec 24 22:13:45 UTC 2026
[HO][INFO][NONE] 
=== Publishing Parking Availability to SP ===
[HO][INFO][NONE] ...
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE]   SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[HO][INFO][NONE] [M3.2] SP public key cached from mTLS handshake
[HO][INFO][NONE] 
→ Publishing availability to SP...
[HO][INFO][NONE]   Spot ID: SPOT-A1
[HO][INFO][NONE]   Valid from: 2025-12-24T22:20:43.634436356Z
[HO][INFO][NONE]   Valid to: 2025-12-25T06:20:43.634436356Z
[HO][INFO][NONE]   Price: 5 tokens
[HO][INFO][NONE]   Location: Downtown-North
[HO][INFO][NONE] 
← Received response from SP
[HO][INFO][NONE] 
╔═══════════════════════════════════════════╗
[HO][INFO][NONE] ║   AVAILABILITY PUBLISHED SUCCESSFULLY     ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════╝
[HO][INFO][NONE] Availability ID: 7661202b-046a-4d44-a83b-c66862840f2d
[HO][INFO][NONE] Message: Parking availability published successfully
[HO][INFO][NONE] 
=== Starting HO Reservation & Payment Server ===
[HO][INFO][NONE] 
╔═══════════════════════════════════════════════════════════╗
[HO][INFO][NONE] ║   HO RESERVATION SERVER CRYPTOGRAPHIC BASELINE           ║
[HO][INFO][NONE] ╚═══════════════════════════════════════════════════════════╝
[HO][INFO][NONE] Version: 2025-12-22 (Milestone 2.4 - Reservation Handshake)
[HO][INFO][NONE] ✓ Enabled TLS protocols: [TLSv1.3, TLSv1.2]
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
[HO][INFO][NONE] === HO Reservation Server Configuration ===
[HO][INFO][NONE] Server listening on port: 8445
[HO][INFO][NONE] Server certificate subject: CN=HomeOwner,O=Parking System,C=BE
[HO][INFO][NONE] Server certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] RSA key size: 2048 bits
[HO][INFO][NONE] Signature algorithm: SHA256withRSA
[HO][INFO][NONE] mTLS enforcement: ENABLED (CO certificates REQUIRED)
[HO][INFO][NONE] 
[HO][INFO][NONE] ...
[HO][INFO][NONE] ==========================================

[HO][INFO][NONE] 
=== Inbound Reservation Request ===
[HO][INFO][NONE] 
║   CO AUTHENTICATED VIA mTLS               ║
[HO][INFO][NONE] CO CN: CarOwner
[HO][INFO][NONE] CO address: /172.20.0.13:55042
[HO][INFO][NONE] CO certificate subject: C=BE,O=Parking System,CN=CarOwner
[HO][INFO][NONE] CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] CO certificate serial: 1CFEF6A6C9CA8B79A1BF9815EE8C4FC7
[HO][INFO][NONE] 
[HO][INFO][NONE] TLS Session Details:
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] ═══════════════════════════════════════════

[HO][INFO][NONE] Received request from CarOwner:
[HO][INFO][NONE] {
  "priceTokens": 5,
  "method": "requestReservation",
  "availabilityId": "7661202b-046a-4d44-a83b-c66862840f2d",
  "spotId": "SPOT-A1",
  "validFrom": "2025-12-24T22:20:43.634436356Z",
  "validTo": "2025-12-25T06:20:43.634436356Z",
  "coIdentity": "CarOwner"
}
[HO][INFO][NONE] 
=== Processing Reservation Request (Milestone 2.4) ===
[HO][INFO][NONE]   Availability ID: 7661202b-046a-4d44-a83b-c66862840f2d
[HO][INFO][NONE]   Spot ID: SPOT-A1
[HO][INFO][NONE]   Valid: 2025-12-24T22:20:43.634436356Z to 2025-12-25T06:20:43.634436356Z
[HO][INFO][NONE]   Price: 5 tokens
[HO][INFO][NONE]   Requested CO Identity: CarOwner
[HO][INFO][NONE] ✓ CO identity verified: CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE] Generated Reservation ID: c5e1ea09-c5e8-460b-b093-5acde2853abf
[HO][INFO][NONE] 
─ Generating Cryptographic Signature ─
[HO][INFO][NONE] Canonical data to sign:
[HO][INFO][NONE]   reservationId=c5e1ea09-c5e8-460b-b093-5acde2853abf|verdict=OK|availabilityId=7661202b-046a-4d44-a83b-c66862840f2d|spotId=SPOT-A1|validFrom=2025-12-24T22:20:43.634436356Z|validTo=2025-12-25T06:20:43.634436356Z|priceTokens=5|coIdentity=CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE]   Algorithm: SHA256withRSA
[HO][INFO][NONE]   Signature length: 256 bytes
[HO][INFO][NONE]   Signature (Base64): JwQ9ODTPVV0Wd+vclGI8wY9dBMItlqBE...
[HO][INFO][NONE] 
╔═══════════════════════════════════════════════════════════╗
[HO][INFO][NONE] ║   RESERVATION DECISION: OK
[HO][INFO][NONE] ╚═══════════════════════════════════════════════════════════╝
[HO][INFO][NONE] Reservation ID: c5e1ea09-c5e8-460b-b093-5acde2853abf
[HO][INFO][NONE] CO Identity: CarOwner
[HO][INFO][NONE] ...
[HO][INFO][NONE] ...
[HO][INFO][NONE] 
Sent signed reservation response:
[HO][INFO][NONE] {
  "hoIdentity": "HomeOwner",
  "reservationId": "c5e1ea09-c5e8-460b-b093-5acde2853abf",
  "signatureAlg": "SHA256withRSA",
  "signature": "JwQ9ODTPVV0Wd+vclGI8wY9dBMItlqBEvKSlKD1gFtmwhzrZKgUEtCIY3M05GzYf3neX7EoTaN7jugvDgpeOMGPThBKtd3QUmz8tw3Khrj7qE9//AMxCdN/dmfVTLztlUvluiUJMQANSoJkzPFHTIEEzrrDYaNwmuQU1/EyyZBskcKtQm7Ov11DSiVkjKSG1Phbbl0Q9yBsuic9XSbtW/l7gvw2QGxBMTuQ/Do1RNQJwJDE8BjOfNAmphu0kFJPeRXmm/gkt7BjB5qWUPe+dZW+fkS2x7KVLfG7Kpee2bzcNcAAih3ofzTolUSLwbPW4C/ZzblM+X4gq/h/wdxtXrA==",
  "signedData": "reservationId=c5e1ea09-c5e8-460b-b093-5acde2853abf|verdict=OK|availabilityId=7661202b-046a-4d44-a83b-c66862840f2d|spotId=SPOT-A1|validFrom=2025-12-24T22:20:43.634436356Z|validTo=2025-12-25T06:20:43.634436356Z|priceTokens=5|coIdentity=CarOwner",
  "verdict": "OK",
  "status": "success"
}
[HO][INFO][NONE] 
CarOwner disconnected

[HO][INFO][NONE] 
=== Inbound Reservation Request ===
[HO][INFO][NONE] 
║   CO AUTHENTICATED VIA mTLS               ║
[HO][INFO][NONE] CO CN: CarOwner
[HO][INFO][NONE] CO address: /172.20.0.13:55056
[HO][INFO][NONE] CO certificate subject: C=BE,O=Parking System,CN=CarOwner
[HO][INFO][NONE] CO certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
[HO][INFO][NONE] CO certificate serial: 1CFEF6A6C9CA8B79A1BF9815EE8C4FC7
[HO][INFO][NONE] 
[HO][INFO][NONE] TLS Session Details:
[HO][INFO][NONE]   Protocol: TLSv1.3
[HO][INFO][NONE]   Cipher suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] ═══════════════════════════════════════════

[HO][INFO][NONE] Received request from CarOwner:
[HO][INFO][NONE] {
  "startIndex": 0,
  "method": "pay",
  "reservationId": "c5e1ea09-c5e8-460b-b093-5acde2853abf",
  "chainId": "ea00a44e-71b2-4f7c-a87a-9006646cb272",
  "rootSignature": "XNmogD+VVHDVvx/s4Wu/JqHpYX7wzRXaha8FW2htbnOcKdyXFrxyswfEndbKTpq/Qh1w81IZ5Cv5MFJ0yK0DSchlV1MNKueYSCEom4UchA+H6mzo8BEYoEhjOyLkBVphepIiya3kaegoE/WdgiBmsvX8nyHhus5Ph6pE7c51vRZG6UymeQI906DJsdwKzCBY3gCstT0ix2DPnCxIY/Tq9bIqxUAYgfPQ/NVi3hf5Oob+wQYMK8xUjdy/Ey4TNGQai5KLLnDNRS8oeEcYrfsp+ZoSBO1VKwj5Oph+4b5Oz0wBN5lYrQgH1gTSz8ClQqIMnqnj3WlOJq+Az5qw9njwlQ==",
  "root": "pUALjyPnuv6+3qJl+EMZM3f6miZawaoYsWubaIoIjh4=",
  "x": 5,
  "tokensToSpend": [
    "1r0zTPPpbNCTeodOYAdYSuqlsTL1t/cxVTh5OwtV6EA=",
    "TnlQL8fNWloTSagqlCxMucw08H0qU/W3sPPSs0YoYRY=",
    "vC6JAxilj3cs1aurTGky0CCVETET0ipUaHCIuaJ7Vx0=",
    "0l4FZsdnP5440zXdb39/eE0peeFXegzLY2KX7zUZfNA=",
    "pUALjyPnuv6+3qJl+EMZM3f6miZawaoYsWubaIoIjh4="
  ]
}
[HO][INFO][NONE] [M3.2] root signature verified via cached SP public key
[HO][INFO][NONE] [M3.2] policy checks passed (reservation verdict OK, token count matches)
[HO][INFO][NONE] [PAY] received from CarOwner
[HO][INFO][NONE] [PAY]   reservationId=c5e1ea09-c5e8-460b-b093-5acde2853abf
[HO][INFO][NONE] [PAY]   chainId=ea00a44e-71b2-4f7c-a87a-9006646cb272
[HO][INFO][NONE] [PAY]   tokenCount=5
[HO][INFO][NONE] [PAY]   startIndex=0
[HO][INFO][NONE] [PAY]   x=5
[HO][INFO][NONE] [PAY]   Hash-chain verification: SUCCESS
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] Preparing Settlement Request to SP
[HO][INFO][NONE] [SETTLE]   chainId: ea00a44e-71b2-4f7c-a87a-9006646cb272
[HO][INFO][NONE] [SETTLE]   reservationId: c5e1ea09-c5e8-460b-b093-5acde2853abf
[HO][INFO][NONE] [SETTLE]   y (tokens spent): 5
[HO][INFO][NONE] [SETTLE]   newLastSpentIndex: 5
[HO][INFO][NONE] [SETTLE]   x (chain length): 5
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] ✓ TLS hardening applied (TLS 1.3/1.2, AEAD ciphers only)
[HO][INFO][NONE] [SETTLE] Initiating explicit TLS handshake...
[HO][INFO][NONE] [SETTLE] ✓ TLS handshake completed successfully
[HO][INFO][NONE] [SETTLE]   Protocol: TLSv1.3
[HO][INFO][NONE] [SETTLE]   Cipher Suite: TLS_AES_256_GCM_SHA384
[HO][INFO][NONE] [SETTLE] ✓ SP certificate verified: C=BE,O=Parking System,CN=ServiceProvider
[HO][INFO][NONE] [SETTLE] → Settlement request sent to SP
[HO][INFO][NONE] [SETTLE] ✓✓✓ SP SETTLEMENT ACCEPTED ✓✓✓
[HO][INFO][NONE] [SETTLE]   chainId: ea00a44e-71b2-4f7c-a87a-9006646cb272
[HO][INFO][NONE] [SETTLE]   acceptedLastSpentIndex: 5
[HO][INFO][NONE] [SETTLE]   tokensConsumed: 5
[HO][INFO][NONE] [SETTLE]   remainingTokens: 0
[HO][INFO][NONE] [SETTLE]   timestamp: 2025-12-24T22:20:57.435920029Z
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [SETTLE] M3.4: Verifying SP Payment Receipt
[HO][INFO][NONE] [SETTLE] ═══════════════════════════════════════════════════
[HO][INFO][NONE] [M3.4-VERIFY] Verifying receipt signature...
[HO][INFO][NONE] [M3.4-VERIFY]   Canonical receipt: receiptId=547b2d66-fef9-4f88-97ba-c6b4c6f865e2|chainId=ea00a44e-71b2-4f7c-a87a-9006646cb272|reservationId=c5e1ea09-c5e8-460b-b093-5acde2853abf|availabilityId=7661202b-046a-4d44-a83b-c66862840f2d|y=5|newLastSpentIndex=5|timestamp=2025-12-24T22:20:57.435920029Z|hoIdentity=HomeOwner
[HO][INFO][NONE] [M3.4-VERIFY]   Signature algorithm: SHA256withRSA
[HO][INFO][NONE] [M3.4-VERIFY] ✓ SP signature verified successfully (RSA-2048, SHA256withRSA)
[HO][INFO][NONE] [M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
[HO][INFO][NONE] [M3.4-VERIFY] ✓ Payment finality established
[HO][INFO][NONE] [SETTLE] ✓ Receipt signature verified successfully
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Receipt persisted: /app/keystore/receipts/receipt_547b2d66-fef9-4f88-97ba-c6b4c6f865e2.json
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Immutable proof of settlement stored
[HO][INFO][NONE] [M3.4-PERSIST] ✓ Available for offline third-party verification
[HO][INFO][NONE] [SETTLE] ✓✓✓ PAYMENT RECEIPT VERIFIED AND PERSISTED ✓✓✓
[HO][INFO][NONE] [SETTLE]   Receipt ID: 547b2d66-fef9-4f88-97ba-c6b4c6f865e2
[HO][INFO][NONE] [SETTLE]   Payment finality established via SP signature
[HO][INFO][NONE] [SETTLE]   Receipt ready for CO forwarding
[HO][INFO][NONE] [PAY] ⚠️  TEST_DOUBLE_SPEND enabled - storing settlement for replay
[HO][INFO][NONE] [PAY] ✓ Payment receipt included in response for CO
[HO][INFO][NONE] [PAY] Payment ACCEPTED. newLastSpentIndex=4
[HO][INFO][NONE] 
Sent pay response:
[HO][INFO][NONE] {
  "startIndex": 0,
  "reservationId": "c5e1ea09-c5e8-460b-b093-5acde2853abf",
  "chainId": "ea00a44e-71b2-4f7c-a87a-9006646cb272",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "c5e1ea09-c5e8-460b-b093-5acde2853abf",
    "signatureAlg": "SHA256withRSA",
    "chainId": "ea00a44e-71b2-4f7c-a87a-9006646cb272",
    "availabilityId": "7661202b-046a-4d44-a83b-c66862840f2d",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "1178DBB3DCA72FEF5EC30642BA185A8441B3F132059EFBEFF2ED978FA4B30094",
    "y": 5,
    "receiptId": "547b2d66-fef9-4f88-97ba-c6b4c6f865e2",
    "canonicalReceipt": "receiptId=547b2d66-fef9-4f88-97ba-c6b4c6f865e2|chainId=ea00a44e-71b2-4f7c-a87a-9006646cb272|reservationId=c5e1ea09-c5e8-460b-b093-5acde2853abf|availabilityId=7661202b-046a-4d44-a83b-c66862840f2d|y=5|newLastSpentIndex=5|timestamp=2025-12-24T22:20:57.435920029Z|hoIdentity=HomeOwner",
    "receiptSignature": "eNR6OZJcPh1PJu+e8Ue5PLgRMy5TNnK6+vvQ5KqgnNWy0OTbOtbdvDeui/4xbq4H5S/ZVqTSLnFR+QCbLrFSS9kTtWvCa0URhGrWvWB/ijoTr4hCaRA/FKk5lDjxW/3zHjC+u8mIeWGEj04gKxp5kDuI3anpo4nZGm6hXPimkoxaS+d5s9Is1FBrhG72FFlCkElzxVKqjhv6LxG26bf8KpEjWSXwuSQjnuFuY5bDaNH6gkmtODqRYDsOm//CSVYT3OIh+6UzdRBemQFvJQgIKg0UAllo4pkTK5cLzR3QNEsLDgSmHGyIYaiXK2hlCOFtB7Ar9XqRy7/Njo+jiv5WTA==",
    "timestamp": "2025-12-24T22:20:57.435920029Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-24T22:20:57.463747779Z"
}
[HO][INFO][NONE] 
CarOwner disconnected

