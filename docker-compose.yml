services:
  cauth:
    build: ./cauth
    container_name: cauth-container
    networks:
      java-network:
        ipv4_address: 172.20.0.10
    ports:
      - "8443:8443"
    volumes:
      - ./crypto_do_once/cauth_server_keystore.p12:/app/keystore.p12
      - ./crypto_do_once/cauth_truststore.p12:/app/truststore.p12
    restart: unless-stopped

  sp:
    build: ./sp
    container_name: sp-container
    networks:
      java-network:
        ipv4_address: 172.20.0.11
    ports:
      - "8444:8444"   # publish SP to host so start.sh can check localhost:8444
    volumes:
      - ./crypto_do_once/sp_truststore.p12:/app/truststore.p12
      - ./crypto_do_once/root_ca.crt:/app/root_ca.crt
      - sp_keystore:/app/keystore
    environment:
      - KEYSTORE_PASSWORD=serverpassword
      - TRUSTSTORE_PASSWORD=trustpassword
      - SP_KEY_ALIAS=sp_key
      - SP_SERVER_PORT=8444
      - CAUTH_HOST=cauth
      - CAUTH_PORT=8443
    depends_on:
      - cauth
    restart: unless-stopped

  ho:
    build: ./ho
    container_name: ho-container
    networks:
      java-network:
        ipv4_address: 172.20.0.12
    ports:
      - "8445:8445"
    volumes:
      - ./crypto_do_once/ho_truststore.p12:/app/truststore.p12
      - ./crypto_do_once/root_ca.crt:/app/root_ca.crt
      - ho_keystore:/app/keystore
    environment:
      - KEYSTORE_PASSWORD=changeit
      - ROOT_CA_PATH=/app/root_ca.crt
      - CAUTH_HOST=cauth
      - CAUTH_PORT=8443
      - SP_HOST=sp
      - SP_PORT=8444
      - HO_SERVER_PORT=8445
      - HOME_OWNER_ID=HO-001
      - SPOT_ID=SPOT-A1
      - LOCATION_ZONE=Downtown-North
      - PRICE_TOKENS=5
      - AVAILABILITY_HOURS=8
      - HO_PAY_PORT=8445
      - TEST_DOUBLE_SPEND=true
      - REPLAY_TEST_MODE=false
    depends_on:
      - cauth
      - sp
    restart: unless-stopped

  co:
    build: ./co
    container_name: co-container
    networks:
      java-network:
        ipv4_address: 172.20.0.13
    volumes:
      - ./crypto_do_once/co_truststore.p12:/app/truststore.p12
      - ./crypto_do_once/root_ca.crt:/app/root_ca.crt
      - co_keystore:/app/keystore
    environment:
      - KEYSTORE_PASSWORD=serverpassword
      - TRUSTSTORE_PASSWORD=trustpassword
      - CO_KEY_ALIAS=co_key
      - CAUTH_HOST=cauth
      - CAUTH_PORT=8443
      - SP_HOST=sp
      - SP_PORT=8444
    depends_on:
      - cauth
      - sp
    restart: "no"

  fake-cauth:
    build: ./fake-cauth
    container_name: fake-cauth-container
    networks:
      java-network:
        ipv4_address: 172.20.0.10
    ports:
      - "8443:8443"
    volumes:
      - ./crypto_do_once/fake_cauth_keystore.p12:/app/keystore.p12
      - ./crypto_do_once/fake_cauth_truststore.p12:/app/truststore.p12
    profiles:
      - test
    restart: "no"

networks:
  java-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  co_keystore:
  ho_keystore:
  sp_keystore:
