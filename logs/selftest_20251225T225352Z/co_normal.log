 Volume "2526-tolga-kuntman-r0917093_co_keystore"  Creating
 Volume "2526-tolga-kuntman-r0917093_co_keystore"  Created
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Thu Dec 25 22:53:16 UTC 2025
Valid until: Fri Dec 25 22:54:16 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 1 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 4de265e1-73a6-473e-8ff0-9e927153a2d4
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-25T22:54:11.920735980Z to 2025-12-26T06:54:11.920735980Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Thu Dec 25 22:53:11 UTC 2025
  Valid until: Fri Dec 25 22:54:11 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: AAB9D74CC14D252F...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: AAB9D74CC14D252F2E92169D386BB399...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 4de265e1-73a6-473e-8ff0-9e927153a2d4

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: AAB9D74CC14D252F2E92169D386BB3996BE85D44FC4637FB09644E07283E0B91
  Received fingerprint: AAB9D74CC14D252F2E92169D386BB3996BE85D44FC4637FB09644E07283E0B91
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 4de265e1-73a6-473e-8ff0-9e927153a2d4
    spotId: SPOT-A1
    validFrom: 2025-12-25T22:54:11.920735980Z
    validTo: 2025-12-26T06:54:11.920735980Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 517b5f93-6d8e-497d-8cb0-cb661ed6d397
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=517b5f93-6d8e-497d-8cb0-cb661ed6d397|verdict=OK|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|spotId=SPOT-A1|validFrom=2025-12-25T22:54:11.920735980Z|validTo=2025-12-26T06:54:11.920735980Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=517b5f93-6d8e-497d-8cb0-cb661ed6d397|verdict=OK|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|spotId=SPOT-A1|validFrom=2025-12-25T22:54:11.920735980Z|validTo=2025-12-26T06:54:11.920735980Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/517b5f93-6d8e-497d-8cb0-cb661ed6d397.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "a9983879-e6c8-4740-a245-0be261694b1f",
  "rootSignature": "iwiDPnZ1C9VWgA5P8++wUxyGaNCYEHNc1ZdgKQAFqgbw9b06mGqC7UPblVp7SkMVZOHhVlil4W70sfNQ6SlR0qx4B8BzloxaCRDhFhNDZKcqzBayPmMom4zOHcs4kCQ8Z59F1LQHJkw3sGsmkxbwzT5+xzGCM6eW2zgfdENfIw/Q2tguCgDtpjzUI8Olg7Egp84+6/UjVvEpiJa/odiPgHRHo+JAy4D7cDYB/j7/AEdnjoEI2dVuKniEFm4PRttL70T0PZ8Sg5qjd4bp5uIWBFR0O1jk0nUlYp+w3GTA4O0ppSwpaPgHGfSrkRvtzvjdQdyTQ4fiKQvJ2ERJ36U65g==",
  "root": "hLMwYheQLqUCGgOsL0n82+kqsZNMPgV72DZ1RIVRCGo=",
  "x": 5,
  "tokens": [
    "skBrFoElWs7gxTmD6FQCTKMxQY8kXGFTDowWq3+2zRk=",
    "8KPvjYvG80JfDVwZstKpnYMxJ2Cgh/yQe5MsSgVq5Pg=",
    "/l3N09zdDlM0e8SpYVwxz4bibKeNX+JcylR1ho3WZ34=",
    "QZwErkLZpO2ICqTCf+QW2SOFIFj0WN/HEkYDpg393LQ=",
    "hLMwYheQLqUCGgOsL0n82+kqsZNMPgV72DZ1RIVRCGo="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: a9983879-e6c8-4740-a245-0be261694b1f
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 84B3306217902EA5021A03AC2F49FCDBE92AB1934C3E057BD83675448551086A
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: B2406B1681255ACE...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: a9983879-e6c8-4740-a245-0be261694b1f
  Using SP-issued token batch, chainId=a9983879-e6c8-4740-a245-0be261694b1f
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: NONE
[M3] Normal payment flow (no negative scenarios)
→ Sending pay request to HO at ho:8445
← HO pay response:
{
  "startIndex": 0,
  "reservationId": "517b5f93-6d8e-497d-8cb0-cb661ed6d397",
  "chainId": "a9983879-e6c8-4740-a245-0be261694b1f",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "517b5f93-6d8e-497d-8cb0-cb661ed6d397",
    "signatureAlg": "SHA256withRSA",
    "chainId": "a9983879-e6c8-4740-a245-0be261694b1f",
    "availabilityId": "4de265e1-73a6-473e-8ff0-9e927153a2d4",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "92804F53851DED8FAD2989EC57023F4577AD3D0268D3E7D7A861828E3A28DDAD",
    "y": 5,
    "receiptId": "2f2b59ec-f305-4e40-90bd-21091897a189",
    "canonicalReceipt": "receiptId=2f2b59ec-f305-4e40-90bd-21091897a189|chainId=a9983879-e6c8-4740-a245-0be261694b1f|reservationId=517b5f93-6d8e-497d-8cb0-cb661ed6d397|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|y=5|newLastSpentIndex=5|timestamp=2025-12-25T22:54:17.665169703Z|hoIdentity=HomeOwner",
    "receiptSignature": "G7+yL4+NzhsyUrUkoPBiYAQy7eVyaVx4YMV38mixNzzegjDzZbsYwPyF4B3BoPUEuUDKdhcdcDU4XhOTAGAepiJrWED7vJc4R8AAijhYcRVehWu5218YuK+Df7x/6r/y1vujnC3DOxseQYS8EJEUrzMvRz35rHifQaXzf/oxZa8205LdcLdlqtcwr8B/kH+fy4AhUwC5mcf2GlXuDmuNMyWOOh12qiOJ3k+Ea5hfzvuV+4PjJVbAAQZ1/q831E8QOypoGkr+puNUUYdLJFLYTK3vRyYfpPHZh6l4/bIkOrELDO8SRw3KDHM4FS2GX0bZ4JkW6Jf6UKH69ClBSD1Cug==",
    "timestamp": "2025-12-25T22:54:17.665169703Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-25T22:54:17.680968582Z"
}
✓✓✓ PAYMENT ACCEPTED BY HO ✓✓✓

═══════════════════════════════════════════════════
M3.4: Verifying Payment Finalization Receipt
═══════════════════════════════════════════════════
[M3.4-VERIFY] Starting receipt verification...
[M3.4-VERIFY] Receipt ID: 2f2b59ec-f305-4e40-90bd-21091897a189
[M3.4-VERIFY] Canonical data: receiptId=2f2b59ec-f305-4e40-90bd-21091897a189|chainId=a9983879-e6c8-4740-a245-0be261694b1f|reservationId=517b5f93-6d8e-497d-8cb0-cb661ed6d397|availabilityId=4de265e1-73a6-473e-8ff0-9e927153a2d4|y=5|newLastSpentIndex=5|timestamp=2025-12-25T22:54:17.665169703Z|hoIdentity=HomeOwner
[M3.4-VERIFY] Signature algorithm: SHA256withRSA
[M3.4-VERIFY] Validating consistency with local payment state...
[M3.4-VERIFY] ✓ Consistency validated
[M3.4-VERIFY]   chainId: a9983879-e6c8-4740-a245-0be261694b1f
[M3.4-VERIFY]   reservationId: 517b5f93-6d8e-497d-8cb0-cb661ed6d397
[M3.4-VERIFY]   tokens spent: 5
[M3.4-VERIFY] Verifying SP signature (RSA-2048, SHA256withRSA)...
[M3.4-VERIFY] ✓ SP signature verified successfully
[M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
[M3.4-VERIFY] ✓ Integrity: Receipt has not been modified
[M3.4-VERIFY] Validating SP certificate to Root CA...
[M3.4-VERIFY] ✓ SP certificate is within validity period
[M3.4-VERIFY] ✓ SP certificate validated
[M3.4-VERIFY] Persisting receipt as immutable proof...
[M3.4-VERIFY] ✓ Receipt persisted: ./keystore/receipts/receipt_2f2b59ec-f305-4e40-90bd-21091897a189.json
[M3.4-VERIFY] ✓ Immutable proof stored for dispute resolution
[M3.4-VERIFY] ✓ Enables offline third-party verification
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] PAYMENT FINALITY ACHIEVED
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] ✓ SP signature verified (cryptographic proof)
[M3.4-VERIFY] ✓ Consistency validated (no substitution)
[M3.4-VERIFY] ✓ Immutable receipt stored (audit trail)
[M3.4-VERIFY] ✓ Non-repudiation guaranteed (SP cannot deny)
[M3.4-VERIFY] ✓ Dispute resolution enabled (third-party verification)
✓✓✓ PAYMENT FINALITY ESTABLISHED ✓✓✓
✓ SP-signed receipt verified
✓ Non-repudiation guaranteed
✓ Immutable proof of payment stored
═══════════════════════════════════════════════════

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 517b5f93-6d8e-497d-8cb0-cb661ed6d397
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
