
==== Sanity checks ====
[INFO] Sanity checks passed
[INFO] Fresh start: docker compose down -v --remove-orphans
 Container ho-container  Stopping
 Container ho-container  Stopped
 Container ho-container  Removing
 Container ho-container  Removed
 Container sp-container  Stopping
 Container sp-container  Stopped
 Container sp-container  Removing
 Container sp-container  Removed
 Container cauth-container  Stopping
 Container cauth-container  Stopped
 Container cauth-container  Removing
 Container cauth-container  Removed
 Network secure_software_assignment_java-network  Removing
 Volume secure_software_assignment_ho_keystore  Removing
 Volume secure_software_assignment_co_keystore  Removing
 Volume secure_software_assignment_sp_keystore  Removing
 Volume secure_software_assignment_co_keystore  Removed
 Volume secure_software_assignment_ho_keystore  Removed
 Volume secure_software_assignment_sp_keystore  Removed
 Network secure_software_assignment_java-network  Removed
[INFO] Starting core services: cauth, sp, ho
#1 [internal] load local bake definitions
#1 reading from stdin 1.59kB done
#1 DONE 0.0s

#2 [sp internal] load build definition from Dockerfile
#2 transferring dockerfile: 652B done
#2 DONE 0.0s

#3 [cauth internal] load build definition from Dockerfile
#3 transferring dockerfile: 756B done
#3 DONE 0.0s

#4 [ho internal] load build definition from Dockerfile
#4 transferring dockerfile: 346B done
#4 DONE 0.0s

#5 [cauth internal] load metadata for docker.io/library/eclipse-temurin:17-jdk
#5 DONE 1.7s

#6 [sp internal] load .dockerignore
#6 transferring context: 91B done
#6 DONE 0.0s

#7 [cauth internal] load .dockerignore
#7 transferring context: 91B done
#7 DONE 0.0s

#8 [cauth 1/5] FROM docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778
#8 resolve docker.io/library/eclipse-temurin:17-jdk@sha256:7995efb7f9276fc16433aa8e2856a06082cd09f7f6603579db2534937ccc6778 done
#8 DONE 0.0s

#9 [cauth internal] load build context
#9 transferring context: 527B done
#9 DONE 0.0s

#10 [sp internal] load build context
#10 transferring context: 528B done
#10 DONE 0.0s

#11 [cauth 4/5] COPY . .
#11 CACHED

#12 [cauth 5/5] RUN mvn clean package -DskipTests
#12 CACHED

#13 [sp 2/5] RUN apt-get update &&     apt-get install -y maven &&     rm -rf /var/lib/apt/lists/*
#13 CACHED

#14 [sp 3/5] WORKDIR /app
#14 CACHED

#15 [sp 4/5] COPY . .
#15 CACHED

#16 [sp 5/5] RUN mvn clean package -DskipTests
#16 CACHED

#17 [cauth] exporting to image
#17 exporting layers done
#17 writing image sha256:97d9242be68c94e75c7f151a50c4d68f39529016a440fe97fc2e03ef7f00b490 done
#17 naming to docker.io/library/secure_software_assignment-cauth done
#17 DONE 0.0s

#18 [sp] exporting to image
#18 exporting layers done
#18 writing image sha256:da148129397fab7448ed0def9cea982834fa0a5e8d0b71dbc0e3f98275b90389 done
#18 naming to docker.io/library/secure_software_assignment-sp done
#18 DONE 0.0s

#19 [cauth] resolving provenance for metadata file
#19 DONE 0.0s

#20 [sp] resolving provenance for metadata file
#20 DONE 0.0s

#21 [ho internal] load metadata for docker.io/library/maven:3.9-eclipse-temurin-17
#21 ...

#22 [ho internal] load metadata for docker.io/library/eclipse-temurin:17-jre
#22 DONE 2.0s

#21 [ho internal] load metadata for docker.io/library/maven:3.9-eclipse-temurin-17
#21 DONE 3.3s

#23 [ho internal] load .dockerignore
#23 transferring context: 2B done
#23 DONE 0.0s

#24 [ho stage-1 1/3] FROM docker.io/library/eclipse-temurin:17-jre@sha256:fc0c46c43f873754d8651948b94da946449aee0c0262420a86c4d18e84bc3c49
#24 DONE 0.0s

#25 [ho build 1/5] FROM docker.io/library/maven:3.9-eclipse-temurin-17@sha256:f7ae6cafd12a38da76a1a105744522387b32caacba5e23674a652133607d007c
#25 DONE 0.0s

#26 [ho internal] load build context
#26 transferring context: 305B done
#26 DONE 0.0s

#27 [ho build 5/5] RUN mvn clean package -DskipTests
#27 CACHED

#28 [ho stage-1 2/3] WORKDIR /app
#28 CACHED

#29 [ho build 2/5] WORKDIR /app
#29 CACHED

#30 [ho build 4/5] COPY src ./src
#30 CACHED

#31 [ho build 3/5] COPY pom.xml .
#31 CACHED

#32 [ho stage-1 3/3] COPY --from=build /app/target/ho-1.0-SNAPSHOT.jar app.jar
#32 CACHED

#33 [ho] exporting to image
#33 exporting layers done
#33 writing image sha256:ed5f3a88e0a7fed794f4ba86d37c6efd51f25ed3d7371530996d710a7e2d1e8b done
#33 naming to docker.io/library/secure_software_assignment-ho done
#33 DONE 0.0s

#34 [ho] resolving provenance for metadata file
#34 DONE 0.0s
 secure_software_assignment-cauth  Built
 secure_software_assignment-sp  Built
 secure_software_assignment-ho  Built
 Network secure_software_assignment_java-network  Creating
 Network secure_software_assignment_java-network  Created
 Volume secure_software_assignment_sp_keystore  Creating
 Volume secure_software_assignment_sp_keystore  Created
 Volume secure_software_assignment_ho_keystore  Creating
 Volume secure_software_assignment_ho_keystore  Created
 Container cauth-container  Creating
 Container cauth-container  Created
 Container sp-container  Creating
 Container sp-container  Created
 Container ho-container  Creating
 Container ho-container  Created
 Container cauth-container  Starting
 Container cauth-container  Started
 Container sp-container  Starting
 Container sp-container  Started
 Container ho-container  Starting
 Container ho-container  Started
[INFO] Waiting for services to become reachable on published host ports...
[INFO] Waiting for localhost:8443
[INFO] Waiting for localhost:8444
[INFO] Waiting for localhost:8445
[INFO] Core services reachable
[INFO] --no-tmux specified; skipping tmux UI setup

==== P1_HONEST: Baseline Normal Flow ====
[INFO] Command: docker compose run --rm co
[INFO] Running CO (scenario=normal) envs: NONE
 Volume secure_software_assignment_co_keystore  Creating
 Volume secure_software_assignment_co_keystore  Created
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
No existing certificate found, enrolling with CAuth...
Step 1: Generating RSA key pair...
✓ RSA-2048 key pair generated successfully

Step 2: Creating Certificate Signing Request (CSR)...
✓ CSR created with subject: CN=CarOwner, O=Parking System, C=BE

Step 3: Connecting to CAuth server over TLS...
✓ TLS connection established to CAuth
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384

→ Sending CSR to CAuth for signing...
Received CA certificate from CAuth.
Received Root CA certificate from CAuth.
Certificate signed by CAuth!
✓ Certificate received from CAuth

Step 4: Storing certificate and private key securely...
✓ Credentials stored in ./keystore/co_keystore.p12

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:01:33 UTC 2025
Valid until: Sat Dec 26 11:02:33 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 1 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:28.806260534Z to 2025-12-26T19:02:28.806260534Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
  Received fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 0148cc02-b185-4cb6-9af4-39445ef94419
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:02:28.806260534Z
    validTo: 2025-12-26T19:02:28.806260534Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 17e4316e-3c57-4f8c-beb6-56be6b156d13
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=17e4316e-3c57-4f8c-beb6-56be6b156d13|verdict=OK|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|spotId=SPOT-A1|validFrom=2025-12-26T11:02:28.806260534Z|validTo=2025-12-26T19:02:28.806260534Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=17e4316e-3c57-4f8c-beb6-56be6b156d13|verdict=OK|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|spotId=SPOT-A1|validFrom=2025-12-26T11:02:28.806260534Z|validTo=2025-12-26T19:02:28.806260534Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/17e4316e-3c57-4f8c-beb6-56be6b156d13.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "8692d187-ac65-4fa1-a4bb-347984532e38",
  "rootSignature": "IJDl5hTPbOy8763A6CyV9Ihx/MUTCx4z5crWYm1KN1il6TuV7WXGSDH1f/ivKHNXJdL1g6Y1TnSYAEEZG4kxCBV8bWQAtPALqx/6XyoXW9lByLI1Ny6t6Ma33z1Cgl99Bj38xt/nqldrS9o1WN1WZVriyGzRon05+KKTdPjvAhPhsnkzDTVron7c2STngKQKzxsRNIrF2V49lXDS/W15OemVS0zJMCS8HXTvc9NgET975KiKnd+I/1kIEB155da/uWQQ8HDNv2Hu6GBLHXxS02eAaGWhQjOMrCCTpokYVhP6bFBQkquMfCVx0w+7OjPF+FRK1SZjg6r+2zeQwldDzQ==",
  "root": "5FExpSZv/yf7+4bZFbA9z/ZrCilCTr/EwjrDcKxrt1A=",
  "x": 5,
  "tokens": [
    "I1o3Iuoi92cuZnl07Jhuks7fNslratPmyoXKHYSdc9g=",
    "Xh7vQvS0KcxWooR7drTsCP91FKfRGlQXTIrHfNWQBqM=",
    "JBQnbpiiWKF82fiw1p+oVZFNerD8aKtmE1ssQ83Syyo=",
    "8stvAFvLUx1gRG6WrphcflsO+cuvSDHyoqVYIhIM2lc=",
    "5FExpSZv/yf7+4bZFbA9z/ZrCilCTr/EwjrDcKxrt1A="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 8692d187-ac65-4fa1-a4bb-347984532e38
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: E45131A5266FFF27FBFB86D915B03DCFF66B0A29424EBFC4C23AC370AC6BB750
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: 235A3722EA22F767...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 8692d187-ac65-4fa1-a4bb-347984532e38
  Using SP-issued token batch, chainId=8692d187-ac65-4fa1-a4bb-347984532e38
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: NONE
[M3] Normal payment flow (no negative scenarios)
→ Sending pay request to HO at ho:8445
← HO pay response:
{
  "startIndex": 0,
  "reservationId": "17e4316e-3c57-4f8c-beb6-56be6b156d13",
  "chainId": "8692d187-ac65-4fa1-a4bb-347984532e38",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "17e4316e-3c57-4f8c-beb6-56be6b156d13",
    "signatureAlg": "SHA256withRSA",
    "chainId": "8692d187-ac65-4fa1-a4bb-347984532e38",
    "availabilityId": "0148cc02-b185-4cb6-9af4-39445ef94419",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "0BD1DAD52C11A983875E822465E7813200C2780F832DAD243365B0FA0A92DEC8",
    "y": 5,
    "receiptId": "df173245-4225-4ec7-a12e-1feb434a947f",
    "canonicalReceipt": "receiptId=df173245-4225-4ec7-a12e-1feb434a947f|chainId=8692d187-ac65-4fa1-a4bb-347984532e38|reservationId=17e4316e-3c57-4f8c-beb6-56be6b156d13|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:02:33.811133287Z|hoIdentity=HomeOwner",
    "receiptSignature": "FuftbmAMjH09kpNXLny3IbCvFv1/zysNrV6UwF1CnA/76Zq4NdMDwp2Oix2sEbem22M3YuoBBqF9DMk0AIOSx4ybXwBQ4FCUOB5UncAG0Vh8AS0g44YoYk6u1WmDZP9xptUs6Ez5OIoS1KA9xlcTN8uJ+bQZdazvUQK/0VcWqsvMZ8bXSIwzGGsHAMtgp3gCL5i0z9Ya0UnlJ8gnk5BkRT7WmcXCgJphfHIeMBvsNkSTo7HxcwPfgIvufg2+HiRvXVnHyE2rKw+6g1DmFhumXCAJ3X8KLz/0SApnvZE3gCPGKHNlb6sIKOjEOOc3orMcIBAYmR9Weo2S6NloQLX88w==",
    "timestamp": "2025-12-26T11:02:33.811133287Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-26T11:02:33.845280037Z"
}
✓✓✓ PAYMENT ACCEPTED BY HO ✓✓✓

═══════════════════════════════════════════════════
M3.4: Verifying Payment Finalization Receipt
═══════════════════════════════════════════════════
[M3.4-VERIFY] Starting receipt verification...
[M3.4-VERIFY] Receipt ID: df173245-4225-4ec7-a12e-1feb434a947f
[M3.4-VERIFY] Canonical data: receiptId=df173245-4225-4ec7-a12e-1feb434a947f|chainId=8692d187-ac65-4fa1-a4bb-347984532e38|reservationId=17e4316e-3c57-4f8c-beb6-56be6b156d13|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:02:33.811133287Z|hoIdentity=HomeOwner
[M3.4-VERIFY] Signature algorithm: SHA256withRSA
[M3.4-VERIFY] Validating consistency with local payment state...
[M3.4-VERIFY] ✓ Consistency validated
[M3.4-VERIFY]   chainId: 8692d187-ac65-4fa1-a4bb-347984532e38
[M3.4-VERIFY]   reservationId: 17e4316e-3c57-4f8c-beb6-56be6b156d13
[M3.4-VERIFY]   tokens spent: 5
[M3.4-VERIFY] Verifying SP signature (RSA-2048, SHA256withRSA)...
[M3.4-VERIFY] ✓ SP signature verified successfully
[M3.4-VERIFY] ✓ Non-repudiation: SP cannot deny issuing this receipt
[M3.4-VERIFY] ✓ Integrity: Receipt has not been modified
[M3.4-VERIFY] Validating SP certificate to Root CA...
[M3.4-VERIFY] ✓ SP certificate is within validity period
[M3.4-VERIFY] ✓ SP certificate validated
[M3.4-VERIFY] Persisting receipt as immutable proof...
[M3.4-VERIFY] ✓ Receipt persisted: ./keystore/receipts/receipt_df173245-4225-4ec7-a12e-1feb434a947f.json
[M3.4-VERIFY] ✓ Immutable proof stored for dispute resolution
[M3.4-VERIFY] ✓ Enables offline third-party verification
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] PAYMENT FINALITY ACHIEVED
[M3.4-VERIFY] ═══════════════════════════════════════════════════
[M3.4-VERIFY] ✓ SP signature verified (cryptographic proof)
[M3.4-VERIFY] ✓ Consistency validated (no substitution)
[M3.4-VERIFY] ✓ Immutable receipt stored (audit trail)
[M3.4-VERIFY] ✓ Non-repudiation guaranteed (SP cannot deny)
[M3.4-VERIFY] ✓ Dispute resolution enabled (third-party verification)
✓✓✓ PAYMENT FINALITY ESTABLISHED ✓✓✓
✓ SP-signed receipt verified
✓ Non-repudiation guaranteed
✓ Immutable proof of payment stored
═══════════════════════════════════════════════════

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 17e4316e-3c57-4f8c-beb6-56be6b156d13
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] normal: PASS (exit=0)

==== M4.1 TOKEN_TAMPER ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=TAMPER -e TAMPER_TOKEN_INDEX=0 -e TAMPER_BYTE_INDEX=0 co
[INFO] Running CO (scenario=token_tamper) envs: NEG_TEST_MODE=TAMPER TAMPER_TOKEN_INDEX=0 TAMPER_BYTE_INDEX=0
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:01:33 UTC 2025
Valid until: Sat Dec 26 11:02:33 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 1 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:28.806260534Z to 2025-12-26T19:02:28.806260534Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
  Received fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: 0148cc02-b185-4cb6-9af4-39445ef94419
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:02:28.806260534Z
    validTo: 2025-12-26T19:02:28.806260534Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: b88b5c24-8313-4246-bb20-2c289eeac9c5
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=b88b5c24-8313-4246-bb20-2c289eeac9c5|verdict=OK|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|spotId=SPOT-A1|validFrom=2025-12-26T11:02:28.806260534Z|validTo=2025-12-26T19:02:28.806260534Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=b88b5c24-8313-4246-bb20-2c289eeac9c5|verdict=OK|availabilityId=0148cc02-b185-4cb6-9af4-39445ef94419|spotId=SPOT-A1|validFrom=2025-12-26T11:02:28.806260534Z|validTo=2025-12-26T19:02:28.806260534Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/b88b5c24-8313-4246-bb20-2c289eeac9c5.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "ef3b7241-eaf2-419a-af67-913765f01678",
  "rootSignature": "VTtmL6n7eeUwK/FLNzdPHrPMAJqh5pGK3u4HqG2B0W2RVhdb96NMdHuhRjcI5j0+VzU2wFVyJ5wSWzkr+A/ESwQTZK5U5rfT0fDMUuR/PV8NmnNyjkqTYtdx+XorumSdNCDHCBxEZi5l5o50RHAAxQQbko7Kke2p29LzmD4DaYwzx028xvlhYv9LCufUGuVSEuzRlMKOFyhDWUDkLQ28o274im15nAkxV9S9NkulKOfhOGy0cW+hPy77PSbhtl9vscBCK1nTSCEdcPcecCF1+uU45OjcT0I10XBY2CKIumdmXZrx1kdzapLCP8g5CzydisWMB483wW1QK9DB0KVFOA==",
  "root": "I5K5Cn/vjACxVCXAViNGwbE4nZSTw4AZTYg8l3BDotg=",
  "x": 5,
  "tokens": [
    "/uo9A2okG4Q9behJsOIcmqpeW5OVVkEZT8uLFTGk78k=",
    "F/cFjfo9Q3GzQiCcalEy02UrN7YMwGqaMbNFJcv8CbQ=",
    "L2t4wMGd1xwwIYErdgsHdEYCH3TI8VuKFAeDrFe8+og=",
    "4jBbwfQHNwN/b+c0/WcF41aaPimRQL0l1dWaFrCu+qw=",
    "I5K5Cn/vjACxVCXAViNGwbE4nZSTw4AZTYg8l3BDotg="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: ef3b7241-eaf2-419a-af67-913765f01678
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 2392B90A7FEF8C00B15425C0562346C1B1389D9493C380194D883C977043A2D8
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: FEEA3D036A241B84...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: ef3b7241-eaf2-419a-af67-913765f01678
  Using SP-issued token batch, chainId=ef3b7241-eaf2-419a-af67-913765f01678
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: TAMPER
[M4.1] Tampering token[0] byte[0]
[M4.1] TOKEN TAMPERING ENABLED: flipped byte 0 of token index 0
[M4.1] Expect HO rejection (adjacency/anchor check failure)
→ Sending TAMPERED pay request to HO at ho:8445
← HO pay response:
{
  "reason": "security_violation",
  "code": "token_tampering_detected",
  "message": "adjacency check failed at i=0 - possible token tampering",
  "status": "error"
}
[M4.1] ✓ Expected rejection received from HO: security_violation

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: b88b5c24-8313-4246-bb20-2c289eeac9c5
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] [RESULT] token_tamper: PASS (exit=0)

==== M4.2 REPLAY (Production): HO rejects locally ====
[INFO] Recreating HO with REPLAY_TEST_MODE=false
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[WARN] Could not verify HO env via docker inspect (may still be correct depending on compose env wiring)
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=REPLAY -e REPLAY_DELAY_MS=1000 co
[INFO] Running CO (scenario=replay_local_reject) envs: NEG_TEST_MODE=REPLAY REPLAY_DELAY_MS=1000
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:01:33 UTC 2025
Valid until: Sat Dec 26 11:02:33 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 2 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: c2a4b1d9-b80b-4c73-99cb-43ef68c88708
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:56.698716881Z to 2025-12-26T19:02:56.698716881Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:28.806260534Z to 2025-12-26T19:02:28.806260534Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: c2a4b1d9-b80b-4c73-99cb-43ef68c88708

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
  Received fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: c2a4b1d9-b80b-4c73-99cb-43ef68c88708
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:02:56.698716881Z
    validTo: 2025-12-26T19:02:56.698716881Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: 990d6e26-2f58-4a99-ba93-b7aeabf2f32d
  Verdict: OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=990d6e26-2f58-4a99-ba93-b7aeabf2f32d|verdict=OK|availabilityId=c2a4b1d9-b80b-4c73-99cb-43ef68c88708|spotId=SPOT-A1|validFrom=2025-12-26T11:02:56.698716881Z|validTo=2025-12-26T19:02:56.698716881Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=990d6e26-2f58-4a99-ba93-b7aeabf2f32d|verdict=OK|availabilityId=c2a4b1d9-b80b-4c73-99cb-43ef68c88708|spotId=SPOT-A1|validFrom=2025-12-26T11:02:56.698716881Z|validTo=2025-12-26T19:02:56.698716881Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/990d6e26-2f58-4a99-ba93-b7aeabf2f32d.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "23074cb0-e516-42a1-a4b0-97248ef5e116",
  "rootSignature": "Q1ew60QzUbej6H05rCBV+P2HtnaYZk+a0HwgpMy3MpE3dNgr/EnYnJElOFW2SzBzVN14knjGD51vcCz/+Aarf0Ux84ijM4OQXw4w9riOK99x5L46Crny0IdhIvI9l0Du94srXDTZmVkKZP9/aKcCrQZSEJ9yWZiALlb0U25386oq+qq7t0neahXzQGtsy6JGt1zyU9DvfuIyFl86reLG+oLvHZkq9yyBGFFeIAQhA68AN26OYzsQn+ewY6Dq2AM7nK3zuhiMLLRLFgUst7bJHiS2L3Pla0kpjw0hrP9kEyg+H2OULceNZneywEZIRoCAyfsj9BBPVaEsIIjSf8xaUQ==",
  "root": "M33eiU+MLDDN0BLgMHoNOAPTECmi/V6b5Yo6KfHNDOM=",
  "x": 5,
  "tokens": [
    "6uDV3dI9ltgP7S2shxGYvfVUvxTazFcxnijcPiekgB8=",
    "FOialzy3tV8wgn6PIAxxe4KSrI73m6kcrlsDTNJvR8A=",
    "y6+jk1JlETR3yCTDC/WmbN2eYHCc6drIoDfDnQQegkk=",
    "QNeRGXZ8zhPRaM/0pVZraZiamoF8qw+tTgvYlzEco1g=",
    "M33eiU+MLDDN0BLgMHoNOAPTECmi/V6b5Yo6KfHNDOM="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 23074cb0-e516-42a1-a4b0-97248ef5e116
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 337DDE894F8C2C30CDD012E0307A0D3803D31029A2FD5E9BE58A3A29F1CD0CE3
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: EAE0D5DDD23D96D8...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 23074cb0-e516-42a1-a4b0-97248ef5e116
  Using SP-issued token batch, chainId=23074cb0-e516-42a1-a4b0-97248ef5e116
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "startIndex": 0,
  "reservationId": "990d6e26-2f58-4a99-ba93-b7aeabf2f32d",
  "chainId": "23074cb0-e516-42a1-a4b0-97248ef5e116",
  "spentCount": 5,
  "newLastSpentIndex": 4,
  "paymentReceipt": {
    "hoIdentity": "HomeOwner",
    "reservationId": "990d6e26-2f58-4a99-ba93-b7aeabf2f32d",
    "signatureAlg": "SHA256withRSA",
    "chainId": "23074cb0-e516-42a1-a4b0-97248ef5e116",
    "availabilityId": "c2a4b1d9-b80b-4c73-99cb-43ef68c88708",
    "newLastSpentIndex": 5,
    "spCertFingerprint": "0BD1DAD52C11A983875E822465E7813200C2780F832DAD243365B0FA0A92DEC8",
    "y": 5,
    "receiptId": "6b4efbfb-1b26-4c0a-95d9-baa64b68c801",
    "canonicalReceipt": "receiptId=6b4efbfb-1b26-4c0a-95d9-baa64b68c801|chainId=23074cb0-e516-42a1-a4b0-97248ef5e116|reservationId=990d6e26-2f58-4a99-ba93-b7aeabf2f32d|availabilityId=c2a4b1d9-b80b-4c73-99cb-43ef68c88708|y=5|newLastSpentIndex=5|timestamp=2025-12-26T11:03:01.557522966Z|hoIdentity=HomeOwner",
    "receiptSignature": "SC0LEXGmJXwgt19VBsnhUqn9S/zCUNpcLNxgI2cJXeM8BwrOlsiHF8Em3YmsU49rC9dvu5d7DQDfgPgvuVUDZ63xQ1zW8ibZH//RbiZf27n0MbWjHYw0bgFJFl84dsZrZ8/CdS/Jh+3W2vA618faVG+boK5WpKc8SHP+8s6wEnVr+2vXg+vdsUrjD8zQf3oXhkTS/iCADGlJGOoIeinlSeMOVJHTAowwE+eZLc/hJRhahjzrhxgoa+dPiYeufv6ixzjIS1SNrYTN6MIHDH8G6nqrKDreaWzuRTcBP5E0tqPTexXxf7NPYK32IBcAEWlVTsMEIxV0oaQjUvTTbCeOLA==",
    "timestamp": "2025-12-26T11:03:01.557522966Z"
  },
  "message": "payment accepted",
  "status": "success",
  "timestamp": "2025-12-26T11:03:01.602755341Z"
}

[M4.2] Waiting 1000 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "settlement_failed",
  "message": "Settlement with SP failed - payment not accepted",
  "status": "error"
}

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: OK
   Non-repudiable proof stored: 990d6e26-2f58-4a99-ba93-b7aeabf2f32d
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
✗ HO rejected payment: Settlement with SP failed - payment not accepted
[INFO] [RESULT] replay_local_reject: PASS (exit=0)

==== M4.2 REPLAY (Test): HO forwards, SP rejects ====
[INFO] Recreating HO with REPLAY_TEST_MODE=true
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[INFO] HO env verified: REPLAY_TEST_MODE=true
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=REPLAY -e REPLAY_DELAY_MS=1000 co
[INFO] Running CO (scenario=replay_sp_reject) envs: NEG_TEST_MODE=REPLAY REPLAY_DELAY_MS=1000
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===
Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=BE,O=Parking System,CN=CarOwner
Issuer: CN=172.20.0.10,O=Private Parking,C=BE
Valid from: Fri Dec 26 11:01:33 UTC 2025
Valid until: Sat Dec 26 11:02:33 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...
← Received availability list from SP

╔═══════════════════════════════════════════════════════════╗
║   AUTHENTICATED AVAILABILITY DISCOVERY SUCCESSFUL         ║
╚═══════════════════════════════════════════════════════════╝
Discovered 3 parking availability record(s)

════════════════════════════════════════════════════════════
Availability #1
════════════════════════════════════════════════════════════
Availability ID: c2a4b1d9-b80b-4c73-99cb-43ef68c88708
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:56.698716881Z to 2025-12-26T19:02:56.698716881Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

✓ Stored availability for reservation request
════════════════════════════════════════════════════════════
Availability #2
════════════════════════════════════════════════════════════
Availability ID: 0148cc02-b185-4cb6-9af4-39445ef94419
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:02:28.806260534Z to 2025-12-26T19:02:28.806260534Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

════════════════════════════════════════════════════════════
Availability #3
════════════════════════════════════════════════════════════
Availability ID: 690fb284-caba-41e4-b306-0c20f9c3a307
Spot ID: SPOT-A1
Price: 5 tokens
Valid: 2025-12-26T11:03:12.263223097Z to 2025-12-26T19:03:12.263223097Z
Location: Downtown-North
Home Owner ID: HO-001

─ HO Certificate Identity Verification ─
✓ HO certificate is within validity period
  Valid from: Fri Dec 26 11:01:28 UTC 2025
  Valid until: Sat Dec 26 11:02:28 UTC 2026
⚠ Note: Full chain validation not possible (intermediate CA cert not provided)
  Relying on certificate fingerprint verification for trust anchor
  In production: SP should include full certificate chain
✓ HO Identity (CN): HomeOwner
  Full Subject: CN=HomeOwner,O=Parking System,C=BE
  Issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ Certificate fingerprint verified: 5CBD6253F39AD9CF...
✓ Identity binding persisted to ./keystore/ho_identity_bindings.txt

✓ HO IDENTITY BINDING ESTABLISHED
  Spot: SPOT-A1 ⟷ HO: HomeOwner
  Fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D...

════════════════════════════════════════════════════════════
✓✓✓ AVAILABILITY DISCOVERY COMPLETE ✓✓✓
════════════════════════════════════════════════════════════
All HO identities verified and bound to availabilities
Identity bindings persisted for future interaction verification

=== Requesting Reservation from HO (Milestone 2.4) ===

═══════════════════════════════════════════════════════════
   MILESTONE 2.4: RESERVATION HANDSHAKE WITH HO
═══════════════════════════════════════════════════════════
✓ CO Identity: CarOwner
✓ Target HO: HomeOwner (ho:8445)
✓ Availability ID: c2a4b1d9-b80b-4c73-99cb-43ef68c88708

--- Loading CO keystore and truststore for mTLS ---
✓ CO keystore loaded
✓ CO truststore loaded (contains Root CA)

--- Establishing mTLS connection to HO ---
✓ TLS hardened: TLS 1.3/1.2, AEAD cipher suites only
✓ mTLS handshake complete
  Protocol: TLSv1.3
  Cipher Suite: TLS_AES_256_GCM_SHA384

--- Verifying HO certificate binding ---
  Expected fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
  Received fingerprint: 5CBD6253F39AD9CF9BFB838FA0D95A1D01702C21361C0B713B337C8F24193841
✓ HO certificate fingerprint verified (matches persisted binding)
✓ HO peer identity verified: HomeOwner

--- Building reservation request ---
  Request fields:
    availabilityId: c2a4b1d9-b80b-4c73-99cb-43ef68c88708
    spotId: SPOT-A1
    validFrom: 2025-12-26T11:02:56.698716881Z
    validTo: 2025-12-26T19:02:56.698716881Z
    priceTokens: 5
    coIdentity: CarOwner
✓ Reservation request sent to HO

--- Received reservation response ---
  Status: success
  Reservation ID: b700783e-beb6-4284-a55e-4ebf0cab340c
  Verdict: NOT_OK
  HO Identity: HomeOwner
  Signature Algorithm: SHA256withRSA

--- Verifying HO signature (RSA-2048) ---
✓ Signature decoded (256 bytes)
✓ Reconstructed canonical data:
  reservationId=b700783e-beb6-4284-a55e-4ebf0cab340c|verdict=NOT_OK|availabilityId=c2a4b1d9-b80b-4c73-99cb-43ef68c88708|spotId=SPOT-A1|validFrom=2025-12-26T11:02:56.698716881Z|validTo=2025-12-26T19:02:56.698716881Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data from HO:
  reservationId=b700783e-beb6-4284-a55e-4ebf0cab340c|verdict=NOT_OK|availabilityId=c2a4b1d9-b80b-4c73-99cb-43ef68c88708|spotId=SPOT-A1|validFrom=2025-12-26T11:02:56.698716881Z|validTo=2025-12-26T19:02:56.698716881Z|priceTokens=5|coIdentity=CarOwner
✓ Signed data matches reconstructed canonical format
✓ HO signature verified successfully (RSA-2048, SHA256withRSA)
✓ HO identity confirmed: HomeOwner
✓ All signature validation checks passed
✓ Non-repudiable proof: HO cannot deny issuing this reservation
✓ Cryptographic proof stored: ./keystore/reservations/b700783e-beb6-4284-a55e-4ebf0cab340c.json

--- Sending payment request to HO (Milestone 3.2 - Using SP tokens) ---
✓ mTLS connection to SP established
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate: C=BE,O=Parking System,CN=ServiceProvider
[M3.4] SP certificate cached for receipt verification

→ Requesting 5 payment tokens from SP...

← Received response from SP
{
  "tokenHashAlg": "SHA-256",
  "signatureAlg": "SHA256withRSA",
  "chainId": "51541cad-e60e-4a2e-a619-e61e7bc781ac",
  "rootSignature": "XB8ITkupMQhG6+T1CySZmVDR2+sXxy+cDS/z10IjYMkE2GEGMG2C9FN7QKib30s3qQU6QtNcuuj1/UoC/By2TM16OV0+MwuYfa7ovU2J8Tqd85RoYCBgwVkMWXf/UOXQP3ihNLofmFvEfduaZsjabPv8QAdQaYKsR8wAfdFgu2Ll5wztKFqZy490OsPA9nYpQ2Qf/YVx+KUurH9cQL99CN2Yli2pq0Wi7FBArklMQRYOOEk+6nCTIFwctposDXKQJbDpRQ4ccDq7hKPh+rPheSz1MkMWRrj585+JTxGTE1kcB2aK3xjCpQ5yDsPOkKCCTd2TnVUjpqrMPSTb9dJMlA==",
  "root": "O+8IdRZlzo2JQ+r3064kxR3sJ3xcN/rUUje25h0YnZQ=",
  "x": 5,
  "tokens": [
    "Pe2wmdsJQ85s0cXxp0+wYHmX0uMpF5DQ/Hss2+qm4n0=",
    "fv824ZBNzU8U9TkatcSozk3zStV/zit8XC4rgTfY67A=",
    "lvKOz4oAaxpOPhaFMNQpKiREVNMWH8F955RXbT/W9lg=",
    "lviEuzaBuUzmqcQfKg8cypNNUsnIv5Qh24Ie8Y48qYw=",
    "O+8IdRZlzo2JQ+r3064kxR3sJ3xcN/rUUje25h0YnZQ="
  ],
  "status": "success"
}

=== Verifying Token Batch ===
Chain ID: 51541cad-e60e-4a2e-a619-e61e7bc781ac
Token count: 5
Tokens received: 5
✓ All tokens are distinct
Root hash: 3BEF08751665CE8D8943EAF7D3AE24C51DEC277C5C37FAD45237B6E61D189D94
✓ Root signature verified with SP's public key

Verifying hash chain:
  Starting with token[0]: 3DEDB099DB0943CE...
  Chain verified: 5 hashes lead to signed root
✓ Hash chain verification successful

═════════════════════════════════════════════
✓✓✓ TOKEN BATCH VERIFIED SUCCESSFULLY ✓✓✓
═════════════════════════════════════════════
Received 5 valid payment tokens from SP
Chain ID: 51541cad-e60e-4a2e-a619-e61e7bc781ac
  Using SP-issued token batch, chainId=51541cad-e60e-4a2e-a619-e61e7bc781ac
  tokensToSpend: indices [0, 5)
  Total tokens to spend: 5 (matching reservation price)

[M4] Negative Test Mode: REPLAY
[M4.2] Attempting replay: sending same pay twice
[M4.2] Attempt #1: Sending pay request...
→ Sending pay request (attempt #1) to HO at ho:8445
← HO response (attempt #1):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}

[M4.2] Waiting 1000 ms before replay...
[M4.2] Attempt #2 REPLAY: Sending same payload again...
→ Sending pay request (attempt #2 REPLAY) to HO at ho:8445
← HO response (attempt #2 REPLAY):
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}
[M4.2] Expect SP settlement rejection on 2nd settle (reason: replay_or_double_spend)
← HO pay response:
{
  "reason": "security_violation",
  "message": "Reservation verdict != OK",
  "status": "error"
}
✗ HO rejected payment: Reservation verdict != OK

═══════════════════════════════════════════════════════════
   RESERVATION HANDSHAKE COMPLETE
   Verdict: NOT_OK
   Non-repudiable proof stored: b700783e-beb6-4284-a55e-4ebf0cab340c
═══════════════════════════════════════════════════════════

✓✓✓ CO SERVICE COMPLETED SUCCESSFULLY ✓✓✓
[INFO] Recreating HO with REPLAY_TEST_MODE=false
 Container ho-container  Recreate
 Container ho-container  Recreated
 Container ho-container  Starting
 Container ho-container  Started
[WARN] Could not verify HO env via docker inspect (may still be correct depending on compose env wiring)
[INFO] [RESULT] replay_sp_reject: PASS (exit=0)

==== ROGUE_CO: BAD_CERT (MISSING) ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=BAD_CERT -e BAD_CERT_MODE=MISSING co
[INFO] Running CO (scenario=bad_cert_missing) envs: NEG_TEST_MODE=BAD_CERT BAD_CERT_MODE=MISSING
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [ROGUE_CO] NEGATIVE TEST MODE: BAD_CERT
  Sub-mode: MISSING
═══════════════════════════════════════════════════════════════
[ROGUE_CO] Testing rejection of CO without valid certificate
[ROGUE_CO] Mode: MISSING
[ROGUE_CO] MISSING mode: Skipping enrollment, no client certificate
[ROGUE_CO] Will attempt mTLS without presenting client certificate

[ROGUE_CO] Attempting mTLS connection to SP...
[ROGUE_CO] EXPECTED: Connection should FAIL
[ROGUE_CO] REASON: No client certificate presented (peer not authenticated)

[ROGUE_CO] Creating SSLContext WITHOUT client KeyManager
[ROGUE_CO] Connecting to SP at sp:8444
[ROGUE_CO] Starting TLS handshake...
[ROGUE_CO] TLS negotiation completed; validating mTLS acceptance...
[ROGUE_CO] Server authenticated: C=BE,O=Parking System,CN=ServiceProvider
[ROGUE_CO] Performing post-handshake proof (send request)...
[ROGUE_CO] Reading response to confirm mTLS acceptance...

╔═══════════════════════════════════════════════════════════════╗
║   [ROGUE_CO] ✓ SECURITY SUCCESS: Rogue CO REJECTED          ║
╚═══════════════════════════════════════════════════════════════╝
[ROGUE_CO] mTLS rejected by peer during client certificate validation!
[ROGUE_CO] Error type: SSLHandshakeException
[ROGUE_CO] Error message: Received fatal alert: bad_certificate
[ROGUE_CO] Analysis: SP rejected the client certificate (fatal alert: bad_certificate)
[ROGUE_CO] Reason: No client certificate presented (peer not authenticated)

[ROGUE_CO] VERIFICATION COMPLETE:
  ✓ CO skipped enrollment (no certificate obtained)
  ✓ CO attempted mTLS without client certificate
  ✓ SP rejected connection (peer not authenticated)
  ✓ System requires valid client certificate for mTLS
  ✓ System correctly enforces client certificate validation
  ✓ No bypass mechanisms available (strong security)

[ROGUE_CO] CONCLUSION: Rogue CO properly rejected!
[ROGUE_CO] The system is SECURE against unauthorized clients.

[INFO] [RESULT] bad_cert_missing: PASS (exit=0)

==== ROGUE_CO: BAD_CERT (SELF_SIGNED) ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=BAD_CERT -e BAD_CERT_MODE=SELF_SIGNED co
[INFO] Running CO (scenario=bad_cert_selfsigned) envs: NEG_TEST_MODE=BAD_CERT BAD_CERT_MODE=SELF_SIGNED
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [ROGUE_CO] NEGATIVE TEST MODE: BAD_CERT
  Sub-mode: SELF_SIGNED
═══════════════════════════════════════════════════════════════
[ROGUE_CO] Testing rejection of CO without valid certificate
[ROGUE_CO] Mode: SELF_SIGNED
[ROGUE_CO] SELF_SIGNED mode: Generating untrusted self-signed certificate
[ROGUE_CO] Generating RSA-2048 keypair for self-signed certificate...
[ROGUE_CO] Self-signed certificate created:
[ROGUE_CO]   BasicConstraints: CA=false
[ROGUE_CO]   KeyUsage: digitalSignature, keyEncipherment
[ROGUE_CO]   ExtendedKeyUsage: clientAuth
[ROGUE_CO] Certificate stored in keystore as PrivateKeyEntry
[ROGUE_CO] Keystore path: ./keystore/co_keystore.p12
[ROGUE_CO] Generated self-signed certificate:
  Subject: C=XX, O=Unauthorized, CN=ROGUE-CO-UNTRUSTED
  Issuer:  C=XX, O=Unauthorized, CN=ROGUE-CO-UNTRUSTED
  Serial:  66822805840749276877214147332760356877
[ROGUE_CO] ⚠ This certificate is NOT chained to trusted Root CA
[ROGUE_CO] ⚠ It is self-signed and will be rejected by services

[ROGUE_CO] Attempting mTLS connection to SP...
[ROGUE_CO] EXPECTED: Connection should FAIL
[ROGUE_CO] REASON: Self-signed cert not chained to Root CA (PKIX validation fails)

[ROGUE_CO] Creating SSLContext WITH self-signed certificate
[ROGUE_CO] Loading keystore to verify certificate availability...
[ROGUE_CO] Keystore loaded successfully:
[ROGUE_CO]   Type: PKCS12
[ROGUE_CO]   Path: ./keystore/co_keystore.p12
[ROGUE_CO]   Alias [1]: co_key
[ROGUE_CO]     Entry type: PrivateKeyEntry (has private key)
[ROGUE_CO]     Subject: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
[ROGUE_CO]     Issuer: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
[ROGUE_CO]     SHA-256: C5EFAF0032102B767150247FBCEBDD5B...
[ROGUE_CO] Certificate is available and ready to be sent during TLS handshake
[ROGUE_CO] KeyManagers created: 1 manager(s)
[ROGUE_CO] KeyManager wrapped to force alias selection: co_key
[ROGUE_CO] SSLContext initialized with wrapped KeyManagers
[ROGUE_CO] Connecting to SP at sp:8444
[ROGUE_CO] Starting TLS handshake...
[ROGUE_CO] chooseClientAlias called - forcing alias: co_key
[ROGUE_CO] TLS negotiation completed; validating mTLS acceptance...
[ROGUE_CO] Server authenticated: C=BE,O=Parking System,CN=ServiceProvider
[ROGUE_CO] Performing post-handshake proof (send request)...
[ROGUE_CO] Reading response to confirm mTLS acceptance...

╔═══════════════════════════════════════════════════════════════╗
║   [ROGUE_CO] ✓ SECURITY SUCCESS: Rogue CO REJECTED          ║
╚═══════════════════════════════════════════════════════════════╝
[ROGUE_CO] mTLS rejected by peer during client certificate validation!
[ROGUE_CO] Error type: SSLHandshakeException
[ROGUE_CO] Error message: Received fatal alert: certificate_unknown

[ROGUE_CO] VERIFICATION COMPLETE:
  ✓ CO generated self-signed certificate
  ✓ CO attempted mTLS with untrusted certificate
  ✓ SP rejected connection (PKIX validation failed)
  ✓ Certificate not chained to trusted Root CA
  ✓ System correctly enforces client certificate validation
  ✓ No bypass mechanisms available (strong security)

[ROGUE_CO] CONCLUSION: Rogue CO properly rejected!
[ROGUE_CO] The system is SECURE against unauthorized clients.

[INFO] [RESULT] bad_cert_selfsigned: PASS (exit=0)

==== FORGED_RESERVATION: RESV_TAMPER FIELD_EDIT ====
[INFO] Command: docker compose run --rm -e NEG_TEST_MODE=RESV_TAMPER -e RESV_TAMPER_MODE=FIELD_EDIT co
[INFO] Running CO (scenario=resv_field_edit) envs: NEG_TEST_MODE=RESV_TAMPER RESV_TAMPER_MODE=FIELD_EDIT
 Container cauth-container  Running
 Container sp-container  Running
Waiting for CAuth, SP, and HO to start...

=== Car Owner (CO) Starting ===

═══════════════════════════════════════════════════════════════
  [RESV_TAMPER] NEGATIVE TEST MODE: FORGED_RESERVATION
  Sub-mode: FIELD_EDIT
═══════════════════════════════════════════════════════════════
[RESV_TAMPER] Testing detection of forged/tampered reservation responses
[RESV_TAMPER] Mode: FIELD_EDIT
[RESV_TAMPER] Tampering will be applied BEFORE signature verification
[RESV_TAMPER] Expected: Signature verification MUST fail

Found existing certificate, loading from keystore...
✓ Certificate validity period verified

╔═══════════════════════════════════════════╗
║   CO CRYPTOGRAPHIC IDENTITY ESTABLISHED   ║
╚═══════════════════════════════════════════╝
Subject: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
Issuer: C=XX,O=Unauthorized,CN=ROGUE-CO-UNTRUSTED
Valid from: Fri Dec 26 11:02:44 UTC 2025
Valid until: Sat Dec 26 11:03:44 UTC 2026

=== Discovering Parking Availabilities from SP ===
Establishing hardened mTLS connection to SP for authenticated discovery...
✓ mTLS connection established to SP
  Protocol: TLSv1.3
  Cipher suite: TLS_AES_256_GCM_SHA384
  SP certificate subject: C=BE,O=Parking System,CN=ServiceProvider
  SP certificate issuer: CN=172.20.0.10,O=Private Parking,C=BE
✓ SP certificate validity verified

→ Requesting parking availabilities from SP...

✖ CRITICAL ERROR: CO failed to start
Reason: Received fatal alert: bad_certificate
javax.net.ssl.SSLHandshakeException: Received fatal alert: bad_certificate
	at java.base/sun.security.ssl.Alert.createSSLException(Unknown Source)
	at java.base/sun.security.ssl.Alert.createSSLException(Unknown Source)
	at java.base/sun.security.ssl.TransportContext.fatal(Unknown Source)
	at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Unknown Source)
	at java.base/sun.security.ssl.TransportContext.dispatch(Unknown Source)
	at java.base/sun.security.ssl.SSLTransport.decode(Unknown Source)
	at java.base/sun.security.ssl.SSLSocketImpl.decode(Unknown Source)
	at java.base/sun.security.ssl.SSLSocketImpl.readApplicationRecord(Unknown Source)
	at java.base/sun.security.ssl.SSLSocketImpl$AppInputStream.read(Unknown Source)
	at java.base/sun.nio.cs.StreamDecoder.readBytes(Unknown Source)
	at java.base/sun.nio.cs.StreamDecoder.implRead(Unknown Source)
	at java.base/sun.nio.cs.StreamDecoder.read(Unknown Source)
	at java.base/java.io.InputStreamReader.read(Unknown Source)
	at java.base/java.io.BufferedReader.fill(Unknown Source)
	at java.base/java.io.BufferedReader.readLine(Unknown Source)
	at java.base/java.io.BufferedReader.readLine(Unknown Source)
	at com.example.Main.discoverAvailabilities(Main.java:1058)
	at com.example.Main.main(Main.java:450)

